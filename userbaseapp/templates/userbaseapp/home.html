<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Base App with Bets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        .spreadsheet-cell {
            padding: 5px 8px;
            border-right: 1px solid #e5e7eb;
            min-width: 100px;
            text-align: left;
            font-size: 0.9rem;
            height: 30px;
            white-space: nowrap;
        }

        .header-cell {
            background-color: #f3f4f6;
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .row-number-cell {
            background-color: #f3f4f6;
            font-weight: 600;
            text-align: center;
            min-width: 50px;
            position: sticky;
            left: 0;
            z-index: 15;
            border-right: 2px solid #d1d5db;
        }

        .data-row:hover .spreadsheet-cell {
            background-color: #f9fafb;
        }

        .bet-button {
            background-color: #4f46e5;
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: 0.7rem;
            margin-left: 4px;
            cursor: pointer;
        }

        .bet-button:hover {
            background-color: #4338ca;
        }

        .delete-button {
            background-color: #ef4444;
            color: white;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.75rem;
            margin-left: 8px;
            cursor: pointer;
            border: none;
        }

        .delete-button:hover {
            background-color: #dc2626;
        }

        .amount-button,
        .jodi-amount-button {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .amount-button:hover,
        .jodi-amount-button:hover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }

        .amount-button.selected,
        .jodi-amount-button.selected {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: white;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            max-width: 420px;
            pointer-events: auto;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 4px solid;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #22c55e;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .toast.error .toast-icon {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .toast.warning .toast-icon {
            background-color: #fef3c7;
            color: #d97706;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .toast.success .toast-title {
            color: #16a34a;
        }

        .toast.error .toast-title {
            color: #dc2626;
        }

        .toast.warning .toast-title {
            color: #d97706;
        }

        .toast-message {
            color: #6b7280;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toast-close:hover {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        /* Update the Jodi Vagar Modal style */
        /* Fix modal to be scrollable with fixed header */
        .modal-content {
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }



        .modal-body-scrollable {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .dadar-amount-button {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .dadar-amount-button:hover {
            border-color: #f97316;
            background-color: #fff7ed;
        }

        .dadar-amount-button.selected {
            border-color: #f97316;
            background-color: #f97316;
            color: white;
        }

        /* Modal Header - Fixed */
        #jodiVagarModal .modal-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

    <div id="toastContainer" class="toast-container"></div>

    <div class="max-w-7xl mx-auto p-4 sm:p-8">
        <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div id="pagination-buttons" class="flex flex-wrap items-center gap-3">
                <button id="page-1-btn"
                    class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 shadow-lg font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    <strong>All SP</strong>
                </button>
                <button id="page-2-btn"
                    class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 shadow-lg font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    <strong>All DP</strong>
                </button>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg shadow-md">
                    <p class="text-xs font-medium">Total Balance</p>
                    <p class="text-xl font-bold" id="totalBalance">₹0</p>
                </div>
                <div class="flex items-center space-x-4 bg-white p-2 rounded-lg shadow-inner border border-gray-200">
                    <p class="text-gray-700 text-sm sm:text-base font-medium">
                        Welcome, <span class="font-semibold text-indigo-700">{{ request.user.get_username }}</span>
                    </p>
                    <a href="{% url 'userbaseapp:logout' %}"
                        class="px-3 py-1 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition text-sm">Logout</a>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table id="spreadsheet-table" class="min-w-full divide-y divide-gray-200 border-collapse table-auto">
                    <thead>
                        <tr>
                            <th class="row-number-cell border-b-2 border-gray-300">Row</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">1</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">2</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">3</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">4</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">5</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">6</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">7</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">8</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">9</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">10</th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheet-body"></tbody>
                </table>
            </div>
        </div>

        <div class="mt-6 flex flex-wrap gap-3 justify-center sm:justify-end px-4 sm:px-0">
            <button id="all-sp-btn"
                class="text-gray-900 bg-gradient-to-r from-lime-200 via-lime-400 to-lime-500 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-lime-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                Place Bet on ALL SP
            </button>
            <button id="all-dp-btn"
                class="text-gray-900 bg-gradient-to-r from-lime-200 via-lime-400 to-lime-500 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-lime-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                Place Bet on ALL DP
            </button>
            <button id="jodi-btn"
                class="text-white bg-gradient-to-r from-purple-500 via-purple-600 to-purple-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-purple-300 shadow-lg font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                Jodi Vagar
            </button>
            <button id="dadar-btn"
                class="text-white bg-gradient-to-r from-orange-500 via-orange-600 to-orange-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-orange-300 shadow-lg font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                Dadar
            </button>
        </div>
    </div>

    <!-- Jodi Vagar Modal -->
    <div id="jodiVagarModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white w-96 rounded-2xl shadow-2xl modal-content"
            style="max-height: 85vh; display: flex; flex-direction: column;">
            <!-- Modal Header - Fixed -->
            <div class="p-6 pb-4 flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Jodi Vagar</h2>
                    <button id="closeJodiModal"
                        class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b flex">
                    <button id="jodiPlaceTab"
                        class="flex-1 py-2 text-center font-semibold border-b-2 border-purple-600 text-purple-600">
                        Place a Bet
                    </button>
                    <button id="jodiHistoryTab"
                        class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-purple-600">
                        History
                    </button>
                </div>
            </div>
            <!-- Scrollable Content Area -->
            <div class="px-6 pb-6 overflow-y-auto flex-1" style="min-height: 0;">
                <!-- Place Bet Content -->
                <div id="jodiPlaceContent">
                    <div class="space-y-4">
                        <!-- Your existing form content here -->
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">Select Type</label>
                            <select id="jodiType"
                                class="w-full border-2 border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="5">Jodi Vagar 5</option>
                                <option value="7">Jodi Vagar 7</option>
                                <option value="12">Jodi Vagar 12</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">Select Column</label>
                            <select id="jodiColumn"
                                class="w-full border-2 border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="1">Column 1</option>
                                <option value="2">Column 2</option>
                                <option value="3">Column 3</option>
                                <option value="4">Column 4</option>
                                <option value="5">Column 5</option>
                                <option value="6">Column 6</option>
                                <option value="7">Column 7</option>
                                <option value="8">Column 8</option>
                                <option value="9">Column 9</option>
                                <option value="10">Column 10</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick amounts:</label>
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                <button class="jodi-amount-button" data-amount="1">₹1</button>
                                <button class="jodi-amount-button" data-amount="2">₹2</button>
                                <button class="jodi-amount-button" data-amount="2.5">₹2.5</button>
                                <button class="jodi-amount-button" data-amount="5">₹5</button>
                            </div>

                            <div class="relative my-4">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">OR</span>
                                </div>
                            </div>

                            <label for="jodiCustomAmount" class="block text-sm font-medium text-gray-700 mb-2">Custom
                                amount
                                (multiples of 10):</label>
                            <input type="number" id="jodiCustomAmount" placeholder="e.g. 10, 50, 100..." min="10"
                                max="10000" step="10"
                                class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" />
                            <p class="text-xs text-gray-500 mt-1">Min: ₹10 | Max: ₹10,000 | Must be multiple of 10</p>
                        </div>

                        <div class="space-y-2 pt-2">
                            <div class="flex gap-2">
                                <button id="cancelJodiBtn"
                                    class="flex-1 px-4 py-2 bg-gray-300 rounded-lg text-gray-800 font-semibold hover:bg-gray-400 transition">Cancel</button>
                                <button id="confirmJodiBtn"
                                    class="flex-1 px-4 py-2 bg-purple-600 rounded-lg text-white font-semibold hover:bg-purple-700 transition">Place
                                    Bet</button>
                            </div>

                            <button id="undoJodiModalBtn"
                                class="w-full px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition hidden">
                                Undo Last Jodi Vagar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Content -->
                <div id="jodiHistoryContent" class="hidden">
                    <div class="p-4 text-center text-gray-500">
                        No history available
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Dadar Modal -->
    <div id="dadarModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white w-96 rounded-2xl shadow-2xl modal-content" 
            style="max-height: 85vh; display: flex; flex-direction: column;">
            <!-- Modal Header - Fixed -->
            <div class="p-6 pb-4 flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Dadar</h2>
                    <button id="closeDadarModalFn" 
                        class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b flex">
                    <button id="dadarPlaceTab"
                        class="flex-1 py-2 text-center font-semibold border-b-2 border-orange-600 text-orange-600">
                        Place a Bet
                    </button>
                    <button id="dadarHistoryTab"
                        class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-orange-600">
                        History
                    </button>
                </div>
            </div>

            <!-- Scrollable Content Area -->
            <div class="px-6 pb-6 overflow-y-auto flex-1" style="min-height: 0;">
                <!-- Place Bet Content -->
                <div id="dadarPlaceContent">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick amounts:</label>
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                <button class="dadar-amount-button" data-amount="1">₹1</button>
                                <button class="dadar-amount-button" data-amount="2">₹2</button>
                                <button class="dadar-amount-button" data-amount="2.5">₹2.5</button>
                                <button class="dadar-amount-button" data-amount="5">₹5</button>
                            </div>

                            <div class="relative my-4">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">OR</span>
                                </div>
                            </div>

                            <label for="dadarCustomAmount"
                                class="block text-sm font-medium text-gray-700 mb-2">Custom amount (multiples of
                                10):</label>
                            <input type="number" id="dadarCustomAmount" placeholder="e.g. 10, 50, 100..."
                                min="10" max="10000" step="10"
                                class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" />
                            <p class="text-xs text-gray-500 mt-1">Min: ₹10 | Max: ₹10,000 | Must be multiple of
                                10</p>
                        </div>

                        <div class="space-y-2 pt-2">
                            <div class="flex gap-2">
                                <button id="cancelDadarBtn"
                                    class="flex-1 px-4 py-2 bg-gray-300 rounded-lg text-gray-800 font-semibold hover:bg-gray-400 transition">Cancel</button>
                                <button id="confirmDadarBtn"
                                    class="flex-1 px-4 py-2 bg-orange-600 rounded-lg text-white font-semibold hover:bg-orange-700 transition">Place
                                    Bet</button>
                            </div>

                            <button id="undoDadarModalBtn"
                                class="w-full px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition hidden">
                                Undo Last Dadar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Content -->
                <div id="dadarHistoryContent" class="hidden">
                    <div class="p-4 text-center text-gray-500">
                        No history available
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Regular Bet Modal -->
    <div id="betModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden z-50 transition">
        <div class="bg-white w-96 rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-lg font-semibold text-gray-800">Place a Bet</h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            </div>

            <div class="border-b mb-4 flex">
                <button id="placeTab"
                    class="flex-1 py-2 text-center font-semibold border-b-2 border-indigo-600 text-indigo-600">Place a
                    Bet</button>
                <button id="historyTab"
                    class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-indigo-600">History</button>
            </div>

            <div id="placeContent">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quick amounts:</label>
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button class="amount-button" data-amount="1">₹1</button>
                    <button class="amount-button" data-amount="2">₹2</button>
                    <button class="amount-button" data-amount="2.5">₹2.5</button>
                    <button class="amount-button" data-amount="5">₹5</button>
                </div>

                <div class="relative my-4">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">OR</span>
                    </div>
                </div>

                <label for="customAmount" class="block text-sm font-medium text-gray-700 mb-2">Custom amount (multiples
                    of 10):</label>
                <input type="number" id="customAmount" placeholder="e.g. 10, 50, 100..." min="10" max="10000" step="10"
                    class="w-full border-2 border-gray-300 rounded-lg p-3 mb-2 text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                <p class="text-xs text-gray-500 mb-4">Min: ₹10 | Max: ₹10,000 | Must be multiple of 10</p>

                <button id="confirmBet"
                    class="w-full bg-indigo-600 text-white py-2 rounded-md font-semibold hover:bg-indigo-700 transition">OK</button>

                <button id="undoBulkBtn"
                    class="w-full mt-2 bg-red-500 text-white py-2 rounded-md font-semibold hover:bg-red-600 transition hidden">Undo
                    Last Bulk</button>
            </div>

            <div id="historyContent" class="hidden">
                <ul id="historyList" class="space-y-2 text-gray-700 text-sm max-h-64 overflow-y-auto"></ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // API Endpoints
            const API = {
                PLACE_BET: '/user/place-bet/',
                PLACE_BULK: '/user/place-bulk-bet/',
                LOAD_BETS: '/user/load-bets/',
                DELETE_BET: '/user/delete-bet/',
                UNDO_BULK: '/user/undo-bulk-action/',
                GET_LAST_BULK: '/user/get-last-bulk-action/',
                GET_BET_TOTAL: '/user/get-bet-total/',
            };

            const rowLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V'];
            const allColumnData = [
                [128, 137, 146, 236, 245, 290, 380, 470, 489, 560, 579, 678, 100, 119, 155, 227, 335, 344, 399, 588, 669, 777],
                [129, 138, 147, 156, 237, 246, 345, 390, 480, 570, 589, 679, 110, 200, 228, 255, 336, 499, 660, 688, 778, 444],
                [120, 139, 148, 157, 238, 247, 256, 346, 490, 580, 670, 689, 166, 229, 300, 337, 355, 445, 599, 779, 788, 111],
                [130, 149, 158, 167, 239, 248, 257, 347, 356, 590, 680, 789, 112, 220, 266, 338, 400, 446, 455, 699, 770, 888],
                [140, 159, 168, 230, 249, 258, 267, 348, 357, 456, 690, 780, 113, 122, 177, 339, 366, 447, 500, 799, 889, 555],
                [123, 150, 169, 178, 240, 259, 268, 349, 358, 367, 457, 790, 114, 277, 330, 448, 466, 556, 600, 880, 899, 222],
                [124, 160, 179, 250, 269, 278, 340, 359, 368, 458, 467, 890, 115, 133, 188, 223, 377, 449, 557, 566, 700, 999],
                [125, 134, 170, 189, 260, 279, 350, 369, 378, 459, 468, 567, 116, 224, 233, 288, 440, 477, 558, 800, 990, 666],
                [126, 135, 180, 234, 270, 289, 360, 379, 450, 469, 478, 568, 117, 144, 199, 225, 388, 559, 577, 667, 900, 333],
                [127, 136, 145, 190, 235, 280, 370, 389, 460, 479, 559, 578, 118, 226, 244, 299, 334, 488, 550, 668, 677, '000']
            ];

            let bets = {};
            let currentNumber = null;
            let currentBulkType = null;
            let lastBulkAction = null;

            const tbody = document.getElementById('spreadsheet-body');
            const page1Btn = document.getElementById('page-1-btn');
            const page2Btn = document.getElementById('page-2-btn');
            const modal = document.getElementById('betModal');
            const closeModalBtn = document.getElementById('closeModal');
            const modalTitle = document.getElementById('modalTitle');
            const confirmBet = document.getElementById('confirmBet');
            const historyList = document.getElementById('historyList');
            const placeTab = document.getElementById('placeTab');
            const historyTab = document.getElementById('historyTab');
            const placeContent = document.getElementById('placeContent');
            const historyContent = document.getElementById('historyContent');
            const customAmountInput = document.getElementById('customAmount');
            const amountButtons = document.querySelectorAll('.amount-button');
            const undoBulkBtn = document.getElementById('undoBulkBtn');
            const jodiModal = document.getElementById('jodiVagarModal');
            const jodiBtn = document.getElementById('jodi-btn');
            const closeJodiModal = document.getElementById('closeJodiModal');
            const cancelJodiBtn = document.getElementById('cancelJodiBtn');
            const confirmJodiBtn = document.getElementById('confirmJodiBtn');
            const jodiAmountButtons = document.querySelectorAll('.jodi-amount-button');
            const jodiCustomAmount = document.getElementById('jodiCustomAmount');
            const undoJodiModalBtn = document.getElementById('undoJodiModalBtn');
            const dadarModal = document.getElementById('dadarModal');
            const dadarBtn = document.getElementById('dadar-btn');
            const closeDadarModal = document.getElementById('closeDadarModal');
            const cancelDadarBtn = document.getElementById('cancelDadarBtn');
            const confirmDadarBtn = document.getElementById('confirmDadarBtn');
            const dadarAmountButtons = document.querySelectorAll('.dadar-amount-button');
            const dadarCustomAmount = document.getElementById('dadarCustomAmount');
            const undoDadarModalBtn = document.getElementById('undoDadarModalBtn');

            function getCSRFToken() {
                return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            }


            function showToast(title, message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                const icons = {
                    success: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>',
                    error: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
                    warning: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
                };

                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || icons.success}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">&times;</button>
                `;

                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                const timeoutId = setTimeout(() => removeToast(toast), 3000);
                toast.querySelector('.toast-close').onclick = () => {
                    clearTimeout(timeoutId);
                    removeToast(toast);
                };
            }

            function removeToast(toast) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }

            async function loadBets() {
                try {
                    const res = await fetch(API.LOAD_BETS);
                    const data = await res.json();
                    if (data.success) {
                        bets = data.bets;
                        renderPage(1);
                    }
                } catch (err) {
                    console.error('Error loading bets:', err);
                }
            }

            async function getLastBulkAction() {
                try {
                    const res = await fetch(API.GET_LAST_BULK);
                    const data = await res.json();
                    lastBulkAction = data.has_action ? data.action : null;
                    updateUndoButton();
                } catch (err) {
                    console.error('Error getting last bulk:', err);
                }
            }

            async function placeSingleBet(number, amount) {
                const res = await fetch(API.PLACE_BET, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ number, amount })
                });
                const data = await res.json();
                if (data.success) {
                    if (!bets[number]) bets[number] = { total: 0, history: [] };
                    bets[number].total += parseFloat(amount);
                    bets[number].history.push({ id: data.bet_id, amount: parseFloat(amount) });
                    updateBetTotal(number);
                }
                return data;
            }

            async function placeBulkBet(type, amount, column = null, jodiType = null) {
                const payload = { type, amount };
                if (type === 'JODI') {
                    payload.column = column;
                    payload.jodi_type = jodiType;
                }
                const res = await fetch(API.PLACE_BULK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    data.bets.forEach(bet => {
                        const num = bet.number;
                        if (!bets[num]) bets[num] = { total: 0, history: [] };
                        bets[num].total += parseFloat(bet.amount);
                        bets[num].history.push({ id: bet.id, amount: parseFloat(bet.amount) });
                        updateBetTotal(num);
                    });
                    lastBulkAction = { id: data.bulk_action_id, type, total_bets: data.total_bets };
                }
                return data;
            }

            async function deleteBet(betId, number) {
                const res = await fetch(API.DELETE_BET, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ bet_id: betId })
                });
                const data = await res.json();
                if (data.success) {
                    const hist = bets[number]?.history;
                    if (hist) {
                        const idx = hist.findIndex(h => h.id === betId);
                        if (idx !== -1) {
                            bets[number].total -= hist[idx].amount;
                            hist.splice(idx, 1);
                        }
                        if (hist.length === 0) delete bets[number];
                    }
                    updateBetTotal(number);
                }
                return data;
            }

            async function undoBulkAction() {
                if (!lastBulkAction) return showToast('Error', 'No bulk action to undo', 'warning');
                if (!confirm(`Undo last ${lastBulkAction.type} bulk action (${lastBulkAction.total_bets} bets)?`)) return;

                const res = await fetch(API.UNDO_BULK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ bulk_action_id: lastBulkAction.id })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Success', data.message, 'success');
                    await loadBets();
                    lastBulkAction = null;
                    await getLastBulkAction();
                    await updateTotalAmount();
                    closeModalFn();
                    closeJodiModalFn();
                    closeDadarModalFn();
                } else {
                    showToast('Error', data.message || 'Failed to undo', 'error');
                }
            }

            async function updateTotalAmount() {
                try {
                    const res = await fetch(API.GET_BET_TOTAL);
                    const data = await res.json();
                    if (data.success) {
                        const totalElement = document.getElementById('totalBalance');
                        totalElement.textContent = `₹${parseFloat(data.total_amount).toLocaleString('en-IN')}`;
                    }
                } catch (err) {
                    console.error('Error fetching total amount:', err);
                }
            }

            function updateBetTotal(number) {
                const el = document.getElementById(`bet-total-${number}`);
                if (el) {
                    el.textContent = bets[number]?.total ? `₹${bets[number].total}` : '';
                }
            }

            function renderPage(page) {
                tbody.innerHTML = '';
                const start = page === 1 ? 0 : 13;
                const end = page === 1 ? 11 : 22;

                if (page === 1) {
                    page1Btn.classList.add('bg-indigo-600', 'text-white');
                    page1Btn.classList.remove('bg-gray-300', 'text-gray-800');
                    page2Btn.classList.add('bg-gray-300', 'text-gray-800');
                    page2Btn.classList.remove('bg-indigo-600', 'text-white');
                } else {
                    page2Btn.classList.add('bg-indigo-600', 'text-white');
                    page2Btn.classList.remove('bg-gray-300', 'text-gray-800');
                    page1Btn.classList.add('bg-gray-300', 'text-gray-800');
                    page1Btn.classList.remove('bg-indigo-600', 'text-white');
                }

                for (let i = start; i <= end; i++) {
                    const row = document.createElement('tr');
                    const dataIndex = i > 12 ? i - 1 : i;
                    const rowNum = document.createElement('td');
                    rowNum.textContent = rowLabels[dataIndex] || (dataIndex + 1);
                    rowNum.classList.add('spreadsheet-cell', 'row-number-cell');
                    row.appendChild(rowNum);

                    for (let j = 0; j < 10; j++) {
                        const cell = document.createElement('td');
                        cell.classList.add('spreadsheet-cell', 'text-gray-700');
                        const value = allColumnData[j][dataIndex];

                        if (value) {
                            const span = document.createElement('span');
                            span.textContent = value;

                            const plus = document.createElement('button');
                            plus.textContent = '+';
                            plus.classList.add('bet-button');
                            plus.onclick = () => openModal(value);

                            const total = document.createElement('span');
                            total.classList.add('ml-2', 'text-sm', 'font-semibold', 'text-green-600');
                            total.id = `bet-total-${value}`;
                            if (bets[value]?.total) total.textContent = `₹${bets[value].total}`;

                            cell.append(span, plus, total);
                        }
                        row.appendChild(cell);
                    }
                    tbody.appendChild(row);
                }
            }

            function openModal(number) {
                currentNumber = number;
                currentBulkType = null;
                modal.classList.remove('hidden');
                modalTitle.textContent = `Place a Bet on ${number}`;
                customAmountInput.value = '';
                amountButtons.forEach(b => b.classList.remove('selected'));
                placeContent.classList.remove('hidden');
                historyContent.classList.add('hidden');
                placeTab.classList.add('border-indigo-600', 'text-indigo-600');
                historyTab.classList.remove('border-indigo-600', 'text-indigo-600');
                updateUndoButton();
                renderHistory();
            }

            function closeModalFn() {
                modal.classList.add('hidden');
            }

            function closeJodiModalFn() {
                jodiModal.classList.add('hidden');
            }
            function closeDadarModalFn() {
                dadarModal.classList.add('hidden');
            }

            function renderHistory() {
                historyList.innerHTML = '';
                const history = bets[currentNumber]?.history || [];
                if (history.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No bets yet.';
                    li.classList.add('text-gray-500', 'italic');
                    historyList.appendChild(li);
                } else {
                    history.forEach((bet, i) => {
                        const li = document.createElement('li');
                        li.classList.add('flex', 'justify-between', 'items-center', 'bg-gray-50', 'p-2', 'rounded');
                        const text = document.createElement('span');
                        text.textContent = `Bet ${i + 1}: ₹${bet.amount}`;
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Delete';
                        delBtn.classList.add('delete-button');
                        delBtn.onclick = async () => {
                            await deleteBet(bet.id, currentNumber);
                            renderHistory();
                        };
                        li.append(text, delBtn);
                        historyList.appendChild(li);
                    });
                }
            }

            // Add this function after renderHistory()
            function renderDadarHistory() {
                const dadarHistoryList = document.getElementById('dadarHistoryContent');
                dadarHistoryList.innerHTML = '';
                
                // Filter bets for Dadar numbers only
                const dadarNumbers = new Set([678, 345, 120, 789, 456, 123, 890, 567, 234, 190].map(String));
                const dadarBets = Object.entries(bets)
                    .filter(([number]) => dadarNumbers.has(number))
                    .flatMap(([number, data]) => 
                        data.history.map(bet => ({
                            ...bet,
                            number
                        }))
                    )
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                if (dadarBets.length === 0) {
                    const div = document.createElement('div');
                    div.className = 'p-4 text-center text-gray-500';
                    div.textContent = 'No Dadar bets found';
                    dadarHistoryList.appendChild(div);
                    return;
                }

                const ul = document.createElement('ul');
                ul.className = 'space-y-2';

                dadarBets.forEach((bet) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    
                    const text = document.createElement('span');
                    text.textContent = `Number ${bet.number}: ₹${bet.amount}`;
                    
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.className = 'delete-button';
                    delBtn.onclick = async () => {
                        const result = await deleteBet(bet.id, bet.number);
                        if (result.success) {
                            await loadBets();
                            renderDadarHistory();
                            await updateTotalAmount();
                        }
                    };
                    
                    li.append(text, delBtn);
                    ul.appendChild(li);
                });

                dadarHistoryList.appendChild(ul);
            }

            function updateUndoButton() {
                undoBulkBtn.classList.add('hidden');
                undoJodiModalBtn.classList.add('hidden');
                undoDadarModalBtn.classList.add('hidden');

                if (lastBulkAction) {
                    if (lastBulkAction.type === 'JODI') {
                        undoJodiModalBtn.classList.remove('hidden');
                    } else if (lastBulkAction.type === 'DADAR') {
                        undoDadarModalBtn.classList.remove('hidden');
                    } else if (currentBulkType && lastBulkAction.type === currentBulkType) {
                        undoBulkBtn.classList.remove('hidden');
                    }
                }
            }

            amountButtons.forEach(btn => {
                btn.onclick = () => {
                    amountButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    customAmountInput.value = '';
                };
            });

            customAmountInput.addEventListener('input', () => {
                amountButtons.forEach(b => b.classList.remove('selected'));
            });

            jodiAmountButtons.forEach(btn => {
                btn.onclick = () => {
                    jodiAmountButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    jodiCustomAmount.value = '';
                };
            });

            jodiCustomAmount.addEventListener('input', () => {
                jodiAmountButtons.forEach(b => b.classList.remove('selected'));
            });

            dadarAmountButtons.forEach(btn => {
                btn.onclick = () => {
                    dadarAmountButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    dadarCustomAmount.value = '';
                };
            });

            dadarCustomAmount.addEventListener('input', () => {
                dadarAmountButtons.forEach(b => b.classList.remove('selected'));
            });

            confirmBet.onclick = async () => {
                let amount = 0;
                const selected = document.querySelector('.amount-button.selected');
                if (selected) {
                    amount = parseFloat(selected.dataset.amount);
                } else {
                    amount = parseFloat(customAmountInput.value);
                }

                if (!amount || amount <= 0) {
                    return showToast('Invalid Amount', 'Please select or enter an amount', 'warning');
                }

                if (!selected) {
                    if (amount < 10) return showToast('Amount Too Low', 'Minimum is ₹10', 'warning');
                    if (amount > 10000) return showToast('Amount Too High', 'Maximum is ₹10,000', 'warning');
                    if (amount % 10 !== 0) return showToast('Invalid Amount', 'Must be multiple of 10', 'warning');
                }

                if (currentBulkType) {
                    const result = await placeBulkBet(currentBulkType, amount);
                    if (result.success) {
                        showToast('Success!', `${result.total_bets} bets placed successfully`, 'success');
                        closeModalFn();
                        renderPage(currentBulkType === 'SP' ? 1 : 2);
                        await getLastBulkAction();
                        await updateTotalAmount();
                    } else {
                        showToast('Error', result.error || 'Failed to place bets', 'error');
                    }
                } else {
                    const result = await placeSingleBet(currentNumber, amount);
                    if (result.success) {
                        renderHistory();
                        closeModalFn();
                        showToast('Success!', `Bet of ₹${amount} placed on ${currentNumber}`, 'success');
                        await updateTotalAmount();
                    } else {
                        showToast('Error', result.error || 'Failed to place bet', 'error');
                    }
                }
            };

            placeTab.onclick = () => {
                placeContent.classList.remove('hidden');
                historyContent.classList.add('hidden');
                placeTab.classList.add('border-indigo-600', 'text-indigo-600');
                historyTab.classList.remove('border-indigo-600', 'text-indigo-600');
                updateUndoButton();
            };

            historyTab.onclick = () => {
                placeContent.classList.add('hidden');
                historyContent.classList.remove('hidden');
                historyTab.classList.add('border-indigo-600', 'text-indigo-600');
                placeTab.classList.remove('border-indigo-600', 'text-indigo-600');
                renderHistory();
            };

            closeModalBtn.onclick = closeModalFn;
            modal.addEventListener('click', e => { if (e.target === modal) closeModalFn(); });

            page1Btn.onclick = () => {
                currentBulkType = null;
                renderPage(1);
            };

            page2Btn.onclick = () => {
                currentBulkType = null;
                renderPage(2);
            };

            document.getElementById('all-sp-btn').onclick = () => {
                currentBulkType = 'SP';
                modal.classList.remove('hidden');
                modalTitle.textContent = 'Place Bet on ALL SP (120 numbers)';
                customAmountInput.value = '';
                amountButtons.forEach(b => b.classList.remove('selected'));
                placeContent.classList.remove('hidden');
                historyContent.classList.add('hidden');
                placeTab.classList.add('border-indigo-600', 'text-indigo-600');
                historyTab.classList.remove('border-indigo-600', 'text-indigo-600');
                updateUndoButton();
            };

            document.getElementById('all-dp-btn').onclick = () => {
                currentBulkType = 'DP';
                modal.classList.remove('hidden');
                modalTitle.textContent = 'Place Bet on ALL DP (100 numbers)';
                customAmountInput.value = '';
                amountButtons.forEach(b => b.classList.remove('selected'));
                placeContent.classList.remove('hidden');
                historyContent.classList.add('hidden');
                placeTab.classList.add('border-indigo-600', 'text-indigo-600');
                historyTab.classList.remove('border-indigo-600', 'text-indigo-600');
                updateUndoButton();
            };

            jodiBtn.onclick = () => {
                jodiModal.classList.remove('hidden');
                jodiCustomAmount.value = '';
                jodiAmountButtons.forEach(b => b.classList.remove('selected'));
                updateUndoButton();
            };

            dadarBtn.onclick = () => {
                dadarModal.classList.remove('hidden');
                dadarCustomAmount.value = '';
                dadarAmountButtons.forEach(b => b.classList.remove('selected'));
                updateUndoButton();
            };

            closeJodiModal.onclick = closeJodiModalFn;
            cancelJodiBtn.onclick = closeJodiModalFn;
            jodiModal.addEventListener('click', e => { if (e.target === jodiModal) closeJodiModalFn(); });

            confirmJodiBtn.onclick = async () => {
                const column = parseInt(document.getElementById('jodiColumn').value);
                const jodiType = parseInt(document.getElementById('jodiType').value);

                let amount = 0;
                const selected = document.querySelector('.jodi-amount-button.selected');
                if (selected) {
                    amount = parseFloat(selected.dataset.amount);
                } else {
                    amount = parseFloat(jodiCustomAmount.value);
                }

                if (!amount || amount <= 0) {
                    return showToast('Invalid Amount', 'Please select or enter an amount', 'warning');
                }

                if (!selected) {
                    if (amount < 10) return showToast('Amount Too Low', 'Minimum is ₹10', 'warning');
                    if (amount > 10000) return showToast('Amount Too High', 'Maximum is ₹10,000', 'warning');
                    if (amount % 10 !== 0) return showToast('Invalid Amount', 'Must be multiple of 10', 'warning');
                }

                const result = await placeBulkBet('JODI', amount, column, jodiType);
                if (result.success) {
                    showToast('Success!', `Jodi Vagar ${jodiType} bet placed on ${result.total_bets} numbers`, 'success');
                    closeJodiModalFn();
                    renderPage(1);
                    await getLastBulkAction();
                    await updateTotalAmount();
                } else {
                    showToast('Error', result.error || 'Failed to place Jodi bet', 'error');
                }
            };

            confirmDadarBtn.onclick = async () => {
                let amount = 0;
                const selected = document.querySelector('.dadar-amount-button.selected');
                if (selected) {
                    amount = parseFloat(selected.dataset.amount);
                } else {
                    amount = parseFloat(dadarCustomAmount.value);
                }

                if (!amount || amount <= 0) {
                    return showToast('Invalid Amount', 'Please select or enter an amount', 'warning');
                }

                if (!selected) {
                    if (amount < 10) return showToast('Amount Too Low', 'Minimum is ₹10', 'warning');
                    if (amount > 10000) return showToast('Amount Too High', 'Maximum is ₹10,000', 'warning');
                    if (amount % 10 !== 0) return showToast('Invalid Amount', 'Must be multiple of 10', 'warning');
                }

                const result = await placeBulkBet('DADAR', amount);
                if (result.success) {
                    showToast('Success!', `Dadar bet placed on ${result.total_bets} numbers`, 'success');
                    closeDadarModalFn();
                    renderPage(1);
                    await getLastBulkAction();
                    await updateTotalAmount();
                    renderDadarHistory();  // Add this line
                } else {
                    showToast('Error', result.error || 'Failed to place Dadar bet', 'error');
                }
            };

            undoBulkBtn.onclick = undoBulkAction;
            undoJodiModalBtn.onclick = undoBulkAction;
            undoDadarModalBtn.onclick = undoBulkAction;

            // Get tab elements
            const dadarPlaceTab = document.getElementById('dadarPlaceTab');
            const dadarHistoryTab = document.getElementById('dadarHistoryTab');
            const dadarPlaceContent = document.getElementById('dadarPlaceContent');
            const dadarHistoryContent = document.getElementById('dadarHistoryContent');

            // Tab switching logic
            dadarPlaceTab.onclick = () => {
                dadarPlaceContent.classList.remove('hidden');
                dadarHistoryContent.classList.add('hidden');
                dadarPlaceTab.classList.add('border-orange-600', 'text-orange-600');
                dadarHistoryTab.classList.remove('border-orange-600', 'text-orange-600');
            };

            dadarHistoryTab.onclick = () => {
                dadarPlaceContent.classList.add('hidden');
                dadarHistoryContent.classList.remove('hidden');
                dadarHistoryTab.classList.add('border-orange-600', 'text-orange-600');
                dadarPlaceTab.classList.remove('border-orange-600', 'text-orange-600');
                renderDadarHistory();  // Add this call
            };

            await loadBets();
            await getLastBulkAction();
            await updateTotalAmount();
        });
    </script>
</body>

</html>