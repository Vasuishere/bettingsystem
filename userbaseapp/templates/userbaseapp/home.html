<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Base App with Bets</title>
    <!-- Preconnect to CDN for faster loading -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        /* Critical CSS - loaded immediately */
        .spreadsheet-cell {
            padding: 5px 8px;
            border-right: 1px solid #e5e7eb;
            min-width: 100px;
            text-align: left;
            font-size: 1.08rem;
            height: 30px;
            white-space: nowrap
        }

        .header-cell {
            background-color: #f3f4f6;
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10
        }

        .row-number-cell {
            background-color: #f3f4f6;
            font-weight: 600;
            text-align: center;
            min-width: 50px;
            position: sticky;
            left: 0;
            z-index: 15;
            border-right: 2px solid #d1d5db
        }

        .data-row:hover .spreadsheet-cell {
            background-color: #f9fafb
        }

        .bet-button {
            background-color: #4f46e5;
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: .7rem;
            margin-left: 4px;
            cursor: pointer
        }

        .bet-button:hover {
            background-color: #4338ca
        }

        .delete-button {
            background-color: #ef4444;
            color: white;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: .75rem;
            margin-left: 8px;
            cursor: pointer;
            border: none
        }

        .delete-button:hover {
            background-color: #dc2626
        }

        .amount-button {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all .2s;
            font-weight: 500
        }

        .amount-button:hover {
            border-color: #4f46e5;
            background-color: #eef2ff
        }

        .amount-button.selected {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: white
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, .15);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            max-width: 420px;
            pointer-events: auto;
            transform: translateX(120%);
            transition: transform .4s cubic-bezier(.68, -.55, .265, 1.55);
            border-left: 4px solid
        }

        .toast.show {
            transform: translateX(0)
        }

        .toast.success {
            border-left-color: #22c55e
        }

        .toast.error {
            border-left-color: #ef4444
        }

        .toast.warning {
            border-left-color: #f59e0b
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0
        }

        .toast.success .toast-icon {
            background-color: #dcfce7;
            color: #16a34a
        }

        .toast.error .toast-icon {
            background-color: #fee2e2;
            color: #dc2626
        }

        .toast.warning .toast-icon {
            background-color: #fef3c7;
            color: #d97706
        }

        .toast-content {
            flex: 1
        }

        .toast-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px
        }

        .toast.success .toast-title {
            color: #16a34a
        }

        .toast.error .toast-title {
            color: #dc2626
        }

        .toast.warning .toast-title {
            color: #d97706
        }

        .toast-message {
            color: #6b7280;
            font-size: 14px
        }

        .toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all .2s
        }

        .toast-close:hover {
            background-color: #f3f4f6;
            color: #4b5563
        }

        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            backdrop-filter: blur(4px)
        }

        .loader-overlay.active {
            display: flex
        }

        .loader-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px
        }

        .loader {
            width: 112px;
            height: 112px;
            position: relative
        }

        .box1,
        .box2,
        .box3 {
            border: 16px solid #f5f5f5;
            box-sizing: border-box;
            position: absolute;
            display: block
        }

        .box1 {
            width: 112px;
            height: 48px;
            margin-top: 64px;
            margin-left: 0;
            animation: abox1 4s 1s forwards ease-in-out infinite
        }

        .box2 {
            width: 48px;
            height: 48px;
            margin-top: 0;
            margin-left: 0;
            animation: abox2 4s 1s forwards ease-in-out infinite
        }

        .box3 {
            width: 48px;
            height: 48px;
            margin-top: 0;
            margin-left: 64px;
            animation: abox3 4s 1s forwards ease-in-out infinite
        }

        @keyframes abox1 {
            0% {
                width: 112px;
                height: 48px;
                margin-top: 64px;
                margin-left: 0
            }

            12.5%,
            25%,
            37.5%,
            50%,
            62.5% {
                width: 48px;
                height: 48px;
                margin-top: 64px;
                margin-left: 0
            }

            75% {
                width: 48px;
                height: 112px;
                margin-top: 0;
                margin-left: 0
            }

            87.5%,
            100% {
                width: 48px;
                height: 48px;
                margin-top: 0;
                margin-left: 0
            }
        }

        @keyframes abox2 {

            0%,
            12.5%,
            25%,
            37.5% {
                width: 48px;
                height: 48px;
                margin-top: 0;
                margin-left: 0
            }

            50% {
                width: 112px;
                height: 48px;
                margin-top: 0;
                margin-left: 0
            }

            62.5%,
            75%,
            87.5%,
            100% {
                width: 48px;
                height: 48px;
                margin-top: 0;
                margin-left: 64px
            }
        }

        @keyframes abox3 {

            0%,
            12.5% {
                width: 48px;
                height: 48px;
                margin-top: 0;
                margin-left: 64px
            }

            25% {
                width: 48px;
                height: 112px;
                margin-top: 0;
                margin-left: 64px
            }

            37.5%,
            50%,
            62.5%,
            75%,
            87.5% {
                width: 48px;
                height: 48px;
                margin-top: 64px;
                margin-left: 64px
            }

            100% {
                width: 112px;
                height: 48px;
                margin-top: 64px;
                margin-left: 0
            }
        }

        .loader-text {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            text-align: center
        }

        body.loading {
            pointer-events: none;
            user-select: none
        }

        body.loading .loader-overlay {
            pointer-events: auto
        }

        .modal-content {
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .modal-body-scrollable {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Checkbox label styling - highlight when checked */
        label:has(input[type="checkbox"]:checked) {
            border-color: currentColor !important;
            background-color: rgba(var(--tw-color-rgb), 0.1);
        }

        /* Sidebar Styles */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            max-width: 90vw;
            height: 100vh;
            background: linear-gradient(to bottom, #ffffff, #f9fafb);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.active {
            right: 0;
        }

        .hamburger-btn {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            z-index: 10;
        }

        .hamburger-btn span {
            width: 28px;
            height: 3px;
            background: #4f46e5;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-btn:hover span {
            background: #6366f1;
        }

        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(8px, 8px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(8px, -8px);
        }

        .highlight-limit {
            background-color: #d5db82 !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">
    <div id="toastContainer" class="toast-container"></div>
    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="p-6">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between mb-8 pb-4 border-b-2 border-indigo-200">
                <h2 class="text-2xl font-bold text-indigo-700">Settings</h2>
                <button id="closeSidebar" class="text-gray-500 hover:text-gray-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Bazar Selector -->
            <div class="mb-6">
                <div class="flex items-center gap-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <label for="bazarSelectorSidebar" class="text-lg font-bold text-gray-800">Select Bazar</label>
                </div>
                <select id="bazarSelectorSidebar"
                    class="w-full px-4 py-3 border-2 border-indigo-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 text-base font-semibold text-gray-700 bg-gradient-to-r from-indigo-50 to-blue-50 cursor-pointer shadow-md hover:shadow-lg transition-all">
                    {% for bazar in bazar_choices %}
                    <option value="{{ bazar.value }}" {% if forloop.first %}selected{% endif %}>{{ bazar.label }}
                    </option>
                    {% endfor %}
                </select>
                <div class="mt-2 px-3 py-2 bg-indigo-50 rounded-lg border border-indigo-200">
                    <p class="text-sm text-gray-600">Current: <span class="font-bold text-indigo-700"
                            id="currentBazarDisplaySidebar">{{ bazar_choices.0.label }}</span></p>
                </div>
            </div>
            <!-- Date Selector -->
            <div class="mb-6">
                <div class="flex items-center gap-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <label for="dateSelectorSidebar" class="text-lg font-bold text-gray-800">Select Date</label>
                </div>
                <select id="dateSelectorSidebar"
                    class="w-full px-4 py-3 border-2 border-green-300 rounded-lg focus:ring-4 focus:ring-green-200 focus:border-green-500 text-base font-semibold text-gray-700 bg-gradient-to-r from-green-50 to-teal-50 cursor-pointer shadow-md hover:shadow-lg transition-all">
                    {% for date in date_options %}
                    <option value="{{ date.value }}" {% if date.is_today %}selected{% endif %}>{{ date.label }}</option>
                    {% endfor %}
                </select>
                <div class="mt-2 px-3 py-2 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-sm text-gray-600">Selected: <span class="font-bold text-green-700"
                            id="currentDateDisplaySidebar">Today</span></p>
                </div>
            </div>
            <!-- User Info -->
            <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
                <div class="flex items-center gap-3 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <p class="text-gray-700 text-base font-medium">Logged in as:</p>
                </div>
                <p class="text-xl font-bold text-indigo-700 ml-9">{{ request.user.get_username }}</p>
            </div>
            <!-- Database Storage Info -->
            <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border-2 border-blue-200">
                <div class="flex items-center gap-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                    </svg>
                    <span class="text-sm font-semibold text-blue-700">Database Storage</span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-600" id="storageUsed">Loading...</span>
                        <span class="font-bold text-blue-700" id="storagePercentage">--%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="storageProgressBar" class="h-3 rounded-full transition-all duration-500"
                            style="width: 0%; background: linear-gradient(to right, #3b82f6, #06b6d4);"></div>
                    </div>
                    <p class="text-xs text-gray-500" id="databaseType">-</p>
                </div>
            </div>
            <!-- Show All Bet Types Toggle -->
            <div class="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-2 border-indigo-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        <span class="text-sm font-semibold text-indigo-700">Show All Bet Types</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="showAllBetTypesToggle" class="sr-only peer" checked>
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </label>
                </div>
                <p class="text-xs text-gray-500 mt-2">When ON, shows all bet type buttons</p>
            </div>
            <!-- Master Delete Button -->
            <button onclick="showMasterDeleteConfirmation()"
                class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-rose-600 to-red-700 text-white font-bold rounded-lg shadow-lg hover:from-rose-700 hover:to-red-800 transition-all transform hover:scale-105 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Master Delete All Bets
            </button>

            <!-- Delete Bazar Database Button -->
            <button onclick="showDeleteBazarConfirmation()"
                class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-orange-500 to-amber-600 text-white font-bold rounded-lg shadow-lg hover:from-orange-600 hover:to-amber-700 transition-all transform hover:scale-105 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete Bazar Database
            </button>

            <!-- Logout Button -->
            <a href="{% url 'userbaseapp:logout' %}"
                class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold rounded-lg shadow-lg hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
            </a>
        </div>
    </div>
    <!-- Loader Overlay -->
    {% include 'userbaseapp/loader.html' %}

    <!-- Master Delete Confirmation Modal -->
    <div id="masterDeleteModal"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[100000]"
        style="backdrop-filter: blur(8px);">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
            <!-- Header -->
            <div class="bg-gradient-to-r from-rose-600 to-red-700 text-white p-6 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h3 class="text-2xl font-bold">Master Delete Warning</h3>
                </div>
            </div>

            <!-- Body -->
            <div class="p-6">
                <div class="mb-6">
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                        <div class="flex items-start">
                            <svg class="h-6 w-6 text-red-500 mr-3 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                                <p class="text-red-800 font-semibold mb-2">‚ö†Ô∏è CRITICAL ACTION</p>
                                <p class="text-red-700 text-sm leading-relaxed">
                                    This will <strong>permanently delete ALL your bets</strong> from the database.
                                    This action <strong>CANNOT be undone</strong>!
                                </p>
                            </div>
                        </div>
                    </div>

                    <p class="text-gray-700 mb-4 font-medium">
                        Total bets to be deleted: <span id="totalBetsCount"
                            class="text-red-600 font-bold text-lg">0</span>
                    </p>

                    <div class="space-y-4">
                        <!-- First Layer: Confirmation Checkbox -->
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" id="confirmDeleteCheckbox"
                                class="mt-1 h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded cursor-pointer">
                            <span class="ml-3 text-sm text-gray-700">
                                I understand this will <strong>permanently delete all my bets</strong> and this action
                                cannot be undone
                            </span>
                        </label>

                        <!-- Second Layer: Password Verification -->
                        <div>
                            <label for="deletePassword" class="block text-sm font-medium text-gray-700 mb-2">
                                Enter your password to confirm:
                            </label>
                            <input type="password" id="deletePassword"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all"
                                placeholder="Your account password" disabled>
                            <p class="text-xs text-gray-500 mt-2">
                                üîí Password verification required for security
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="cancelMasterDelete()"
                        class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-all">
                        Cancel
                    </button>
                    <button id="confirmMasterDeleteBtn" onclick="executeMasterDelete()"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-rose-600 to-red-700 text-white font-bold rounded-lg hover:from-rose-700 hover:to-red-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        Delete All Bets
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Bazar Database Confirmation Modal -->
    <div id="deleteBazarModal"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[100000]"
        style="backdrop-filter: blur(8px);">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
            <!-- Header -->
            <div class="bg-gradient-to-r from-orange-500 to-amber-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h3 class="text-2xl font-bold">Delete Bazar Data</h3>
                </div>
            </div>

            <!-- Body -->
            <div class="p-6">
                <div class="mb-6">
                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-4">
                        <div class="flex items-start">
                            <svg class="h-6 w-6 text-orange-500 mr-3 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                                <p class="text-orange-800 font-semibold mb-2">‚ö†Ô∏è WARNING</p>
                                <p class="text-orange-700 text-sm leading-relaxed">
                                    This will <strong>permanently delete all bets</strong> for the selected bazar and date.
                                    This action <strong>CANNOT be undone</strong>!
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-100 rounded-lg p-4 mb-4">
                        <p class="text-gray-700 mb-2">
                            <span class="font-semibold">Bazar:</span> <span id="deleteBazarName" class="text-orange-600 font-bold">-</span>
                        </p>
                        <p class="text-gray-700 mb-2">
                            <span class="font-semibold">Date:</span> <span id="deleteBazarDate" class="text-orange-600 font-bold">-</span>
                        </p>
                        <p class="text-gray-700">
                            <span class="font-semibold">Total bets to delete:</span> <span id="bazarBetsCount" class="text-orange-600 font-bold text-lg">0</span>
                        </p>
                    </div>

                    <div class="space-y-4">
                        <!-- Confirmation Checkbox -->
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" id="confirmBazarDeleteCheckbox"
                                class="mt-1 h-5 w-5 text-orange-600 focus:ring-orange-500 border-gray-300 rounded cursor-pointer">
                            <span class="ml-3 text-sm text-gray-700">
                                I understand this will <strong>permanently delete all bets</strong> for this bazar and date
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="cancelBazarDelete()"
                        class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-all">
                        Cancel
                    </button>
                    <button id="confirmBazarDeleteBtn" onclick="executeBazarDelete()"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-amber-600 text-white font-bold rounded-lg hover:from-orange-600 hover:to-amber-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        Delete Bazar Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-8">
        <!-- Header with Bazar Info (Left) and Action Buttons (Right) -->
        <div
            class="mb-6 bg-white rounded-xl shadow-lg p-4 border-2 border-indigo-200 flex items-center justify-between flex-wrap gap-4">
            <!-- Left Side: Bazar Name, Date, Total Balance -->
            <div class="flex items-center gap-3 flex-wrap">
                <div
                    class="px-4 py-2 bg-gradient-to-r from-indigo-100 to-purple-100 rounded-lg border-2 border-indigo-300 shadow-sm">
                    <span class="text-xs font-medium text-indigo-600">Bazar</span>
                    <p class="text-sm font-bold text-indigo-800" id="currentBazarDisplay">Sridevi Open</p>
                </div>
                <div
                    class="px-4 py-2 bg-gradient-to-r from-green-100 to-teal-100 rounded-lg border-2 border-green-300 shadow-sm">
                    <span class="text-xs font-medium text-green-600">Date</span>
                    <p class="text-sm font-bold text-green-800" id="currentDateDisplay">Today</p>
                </div>
                <!-- Desktop total balance -->
                <div
                    class="hidden sm:flex px-4 py-2 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-lg border-2 border-yellow-300 shadow-sm flex-col">
                    <div class="flex items-center justify-between gap-2">
                        <span class="text-xs font-medium text-yellow-600">Count</span>
                        <button id="refreshBalanceBtn" title="Refresh Balance"
                            class="text-yellow-600 hover:text-yellow-800 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-lg font-bold text-orange-700" id="totalBalance">0</p>
                </div>
                <!-- Mobile total balance -->
                <div
                    class="sm:hidden px-4 py-2 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-lg border-2 border-yellow-300 shadow-sm">
                    <div class="flex items-center justify-between gap-2">
                        <span class="text-xs font-medium text-yellow-600">Balance</span>
                        <button id="refreshBalanceBtnMobile" title="Refresh Balance"
                            class="text-yellow-600 hover:text-yellow-800 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-lg font-bold text-orange-700" id="totalBalanceMobile">0</p>
                </div>
            </div>
            <!-- Right Side: History, Quick Bet, Hamburger Menu -->
            <div class="flex items-center gap-2">
                <button id="toggleHistoryBtn"
                    class="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-medium rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="hidden sm:inline">History</span>
                </button>
                <button id="toggleQuickBetBtn"
                    class="px-4 py-2 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-medium rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                    <span class="hidden sm:inline">Quick Bet</span>
                </button>
                <button id="openSidebar" class="hamburger-btn" aria-label="Open menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
        <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div id="pagination-buttons" class="flex flex-wrap items-center gap-3">
                <button id="page-1-btn"
                    class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 shadow-lg font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    <strong>All SP</strong>
                </button>
                <div
                    class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg border-2 border-red-300 shadow-md">
                    <label for="sp-limit-input" class="text-xs font-semibold text-red-700 whitespace-nowrap">SP
                        Limit</label>
                    <input type="number" id="sp-limit-input"
                        class="w-20 px-2 py-1 text-sm border-2 border-red-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                        placeholder="0" min="0">
                </div>
                <button id="page-2-btn"
                    class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 shadow-lg font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    <strong>All DP</strong>
                </button>
                <div
                    class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg border-2 border-red-300 shadow-md">
                    <label for="dp-limit-input" class="text-xs font-semibold text-red-700 whitespace-nowrap">DP
                        Limit</label>
                    <input type="number" id="dp-limit-input"
                        class="w-20 px-2 py-1 text-sm border-2 border-red-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                        placeholder="0" min="0">
                </div>
            </div>
        </div>
        <div id="quickBetContainer"
            class="hidden mt-6 bg-white rounded-xl shadow-2xl border-2 border-indigo-500 p-4 mx-auto" style="max-width: 400px;">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold text-indigo-700">Quick Bet Entry</h3>
                <button id="closeQuickBetBtn" class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            </div>
            <div class="overflow-auto" style="max-height: 400px;">
                <table class="w-full border-collapse text-sm">
                    <thead class="bg-indigo-100 sticky top-0">
                        <tr>
                            <th class="border border-gray-300 px-1 py-1 text-xs font-semibold text-gray-700 w-8">Row</th>
                            <th class="border border-gray-300 px-1 py-1 text-xs font-semibold text-gray-700">Number</th>
                            <th class="border border-gray-300 px-1 py-1 text-xs font-semibold text-gray-700">Amount</th>
                            <th class="border border-gray-300 px-1 py-1 text-xs font-semibold text-gray-700 w-8"></th>
                        </tr>
                    </thead>
                    <tbody id="quickBetTableBody">
                        <tr data-row="1">
                            <td class="border border-gray-300 px-1 py-1 text-center text-xs font-medium text-gray-600">1</td>
                            <td class="border border-gray-300 p-1">
                                <input type="text"
                                    class="quick-bet-number w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="3-digit" maxlength="3" data-row="1">
                            </td>
                            <td class="border border-gray-300 p-1">
                                <input type="number"
                                    class="quick-bet-amount w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Amt" min="1" data-row="1">
                            </td>
                            <td class="border border-gray-300 p-0 text-center">
                                <button
                                    class="remove-row-btn text-red-500 hover:text-red-700 hover:bg-red-50 rounded p-0.5 transition"
                                    title="Remove row">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        <tr data-row="2">
                            <td class="border border-gray-300 px-1 py-1 text-center text-xs font-medium text-gray-600">2</td>
                            <td class="border border-gray-300 p-1">
                                <input type="text"
                                    class="quick-bet-number w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="3-digit" maxlength="3" data-row="2">
                            </td>
                            <td class="border border-gray-300 p-1">
                                <input type="number"
                                    class="quick-bet-amount w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Amt" min="1" data-row="2">
                            </td>
                            <td class="border border-gray-300 p-0 text-center">
                                <button
                                    class="remove-row-btn text-red-500 hover:text-red-700 hover:bg-red-50 rounded p-0.5 transition"
                                    title="Remove row">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Same Amount for All Checkbox -->
            <div class="mt-3 flex items-center gap-2 px-2 py-2 bg-blue-50 rounded-lg border border-blue-200">
                <input type="checkbox" id="sameAmountCheckbox"
                    class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                <label for="sameAmountCheckbox" class="text-sm font-medium text-gray-700 cursor-pointer">
                    Use same amount for all numbers
                </label>
            </div>
            <div class="mt-3 flex gap-2">
                <button id="quickBetOkayBtn"
                    class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 shadow-md transition">
                    Place Bets
                </button>
                <button id="quickBetClearBtn"
                    class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 shadow-md transition">
                    Clear
                </button>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table id="spreadsheet-table" class="min-w-full divide-y divide-gray-200 border-collapse table-auto">
                    <thead>
                        <tr>
                            <th class="row-number-cell border-b-2 border-gray-300">Row</th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>1</span>
                                    <span id="column-total-1" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>2</span>
                                    <span id="column-total-2" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>3</span>
                                    <span id="column-total-3" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>4</span>
                                    <span id="column-total-4" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>5</span>
                                    <span id="column-total-5" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>6</span>
                                    <span id="column-total-6" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>7</span>
                                    <span id="column-total-7" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>8</span>
                                    <span id="column-total-8" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>9</span>
                                    <span id="column-total-9" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                            <th class="spreadsheet-cell header-cell border-b-2 border-gray-300">
                                <div class="flex items-center justify-center gap-2">
                                    <span>10</span>
                                    <span id="column-total-10" class="text-xs font-bold text-emerald-600"></span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheet-body"></tbody>
                </table>
            </div>
        </div>
        <div id="betButtonsContainer" class="mt-6 flex flex-wrap gap-3 justify-center sm:justify-end px-4 sm:px-0">
            <button id="all-sp-btn"
                class="text-gray-900 bg-gradient-to-r from-lime-200 via-lime-400 to-lime-500 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-lime-300 font-bold rounded-lg text-base px-5 py-2.5 text-center">
                SP
            </button>
            <button id="all-dp-btn"
                class="text-gray-900 bg-gradient-to-r from-lime-200 via-lime-400 to-lime-500 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-lime-300 font-bold rounded-lg text-base px-5 py-2.5 text-center">
                DP
            </button>
            <button id="jodi-btn"
                class="text-white bg-gradient-to-r from-purple-500 via-purple-600 to-purple-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-purple-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Jodi Vagar
            </button>
            <button id="eki-beki-btn"
                class="text-white bg-gradient-to-r from-cyan-500 via-cyan-600 to-cyan-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-cyan-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Eki/Beki/Dadar
            </button>
            <button id="abr-cut-btn"
                class="text-white bg-gradient-to-r from-pink-500 via-pink-600 to-pink-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-pink-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                ABR Cut
            </button>
            <button id="jodi-panel-btn"
                class="text-white bg-gradient-to-r from-teal-500 via-teal-600 to-teal-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-teal-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Jodi Pana
            </button>
            <button id="motar-btn"
                class="text-white bg-gradient-to-r from-orange-500 via-orange-600 to-orange-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-orange-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Motar
            </button>
            <button id="comman-pana-btn"
                class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Common Pana
            </button>
            <button id="group-bet-btn"
                class="text-white bg-gradient-to-r from-rose-500 via-rose-600 to-rose-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-rose-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Group
            </button>
            <button id="column-bet-btn"
                class="text-white bg-gradient-to-r from-emerald-500 via-emerald-600 to-emerald-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-emerald-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Akkda
            </button>
            <button id="set-pana-btn"
                class="text-white bg-gradient-to-r from-indigo-500 via-indigo-600 to-indigo-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-indigo-300 shadow-lg font-bold rounded-lg text-base px-5 py-2.5 text-center">
                Set Pana
            </button>
        </div>
        <!-- Quick Bet Entry Table -->
    </div>
    <!-- Bulk Action History Modal (Full Screen) -->
    <div id="historyModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 h-5/6 flex flex-col">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                <h2 class="text-2xl font-bold text-purple-700">üìã Bet History</h2>
                <button id="closeHistoryModal"
                    class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>

            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200 px-6 pt-4 flex-shrink-0">
                <button id="bulkActionsTab"
                    class="px-6 py-3 text-sm font-semibold border-b-2 border-indigo-600 text-indigo-600 transition-colors">
                    Bulk Actions
                </button>
                <button id="individualBetsTab"
                    class="px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">
                    Individual Bets
                </button>
            </div>

            <!-- Bulk Actions Content -->
            <div id="bulkActionsContent" class="flex-1 overflow-auto p-6">
                <div class="overflow-x-auto">
                    <table id="historyTable" class="w-full border-collapse border border-gray-300">
                        <thead class="bg-purple-100 sticky top-0">
                            <tr>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    ID</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Action Type</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Bazar</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Date</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Amount</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Total Bets</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Column</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Number</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Timestamp</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Status</th>
                                <th
                                    class="border border-gray-300 px-4 py-3 text-center text-sm font-bold text-gray-700">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="bg-white">
                            <tr>
                                <td colspan="11" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                    Loading history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Individual Bets Content -->
            <div id="individualBetsContent" class="hidden flex-1 overflow-auto p-6">
                <div class="overflow-x-auto">
                    <table id="individualBetsTable" class="w-full border-collapse border border-gray-300">
                        <thead class="bg-blue-100 sticky top-0">
                            <tr>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    ID</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Number</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Amount</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Bet Type</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Bazar</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Date</th>
                                <th class="border border-gray-300 px-4 py-3 text-left text-sm font-bold text-gray-700">
                                    Timestamp</th>
                                <th
                                    class="border border-gray-300 px-4 py-3 text-center text-sm font-bold text-gray-700">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody id="individualBetsTableBody" class="bg-white">
                            <tr>
                                <td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                    Loading individual bets...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Footer with Stats -->
            <div class="p-6 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div class="flex gap-6">
                        <div>
                            <span class="text-sm font-medium text-gray-600">Total Records:</span>
                            <span id="totalRecords" class="text-lg font-bold text-purple-700 ml-2">0</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Total Amount:</span>
                            <span id="totalHistoryAmount" class="text-lg font-bold text-green-600 ml-2">0</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-600">Total Bets:</span>
                            <span id="totalHistoryBets" class="text-lg font-bold text-blue-600 ml-2">0</span>
                        </div>
                    </div>
                    <button id="refreshHistoryBtn"
                        class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Universal Modal -->
    <div id="universalModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white w-96 rounded-2xl shadow-2xl modal-content"
            style="max-height: 85vh; display: flex; flex-direction: column;">
            <!-- Modal Header - Fixed -->
            <div class="p-6 pb-4 flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modalTitle" class="text-xl font-semibold text-gray-800">Place a Bet</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
                </div>
                <!-- Tab Navigation -->
                <div class="border-b flex">
                    <button id="placeTab"
                        class="flex-1 py-2 text-center font-semibold border-b-2 border-indigo-600 text-indigo-600">
                        Place a Bet
                    </button>
                    <button id="historyTab"
                        class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-indigo-600">
                        History
                    </button>
                </div>
            </div>
            <!-- Scrollable Content Area -->
            <div class="px-6 pb-6 overflow-y-auto flex-1" style="min-height: 0;">
                <!-- Place Bet Content -->
                <div id="placeContent">
                    <div class="space-y-4">
                        <!-- SINGLE, SP, DP Options -->
                        <div id="columnOptions" class="hidden space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Columns</label>
                                <div class="grid grid-cols-5 gap-2">
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="1"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">1</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="2"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">2</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="3"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">3</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="4"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">4</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="5"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">5</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="6"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">6</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="7"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">7</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="8"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">8</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="9"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">9</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-indigo-50 transition">
                                        <input type="checkbox" value="10"
                                            class="betColumnCheckbox w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-medium">10</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Jodi Options -->
                        <div id="jodiOptions" class="hidden space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Type</label>
                                <select id="jodiType"
                                    class="w-full border-2 border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="5">Jodi Vagar 5</option>
                                    <option value="7">Jodi Vagar DP 7</option>
                                    <option value="12">Jodi Vagar 12</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Columns</label>
                                <div class="grid grid-cols-5 gap-2">
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="1"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">1</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="2"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">2</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="3"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">3</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="4"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">4</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="5"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">5</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="6"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">6</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="7"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">7</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="8"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">8</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="9"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">9</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-purple-50 transition">
                                        <input type="checkbox" value="10"
                                            class="jodiColumnCheckbox w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                        <span class="text-sm font-medium">10</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Eki/Beki/Dadar Options -->
                        <div id="ekiBekiOptions" class="hidden space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Type</label>
                                <select id="ekiBekiType"
                                    class="w-full border-2 border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                    <option value="EKI">Eki (13579) - 10 numbers</option>
                                    <option value="BEKI">Beki (24680) - 10 numbers</option>
                                    <option value="DADAR">Dadar - 10 numbers</option>
                                </select>
                            </div>
                        </div>
                        <!-- ABR Cut Options -->
                        <div id="abrCutOptions" class="hidden space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Columns</label>
                                <div class="grid grid-cols-5 gap-2">
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="1"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">1</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="2"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">2</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="3"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">3</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="4"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">4</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="5"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">5</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="6"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">6</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="7"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">7</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="8"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">8</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="9"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">9</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-pink-50 transition">
                                        <input type="checkbox" value="10"
                                            class="abrCutColumnCheckbox w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                        <span class="text-sm font-medium">10</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Jodi Panel Options -->
                        <div id="jodiPanelOptions" class="hidden space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Type</label>
                                <select id="jodiPanelType"
                                    class="w-full border-2 border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="9">Jodi Panel 9 (All 9 numbers)</option>
                                    <option value="7">Jodi Panel 7 (First 7 numbers)</option>
                                    <option value="6">Jodi Panel 6 (First 6 numbers)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Columns</label>
                                <div class="grid grid-cols-5 gap-2">
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="1"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">1</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="2"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">2</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="3"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">3</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="4"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">4</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="5"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">5</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="6"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">6</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="7"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">7</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="8"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">8</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="9"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">9</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-teal-50 transition">
                                        <input type="checkbox" value="10"
                                            class="jodiPanelColumnCheckbox w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                        <span class="text-sm font-medium">10</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Motar Options -->
                        <div id="motarOptions" class="hidden space-y-4">
                            <!-- Multiple Motar Checkbox -->
                            <div class="flex items-center space-x-3 p-3 border-2 border-orange-200 rounded-lg bg-orange-50">
                                <input type="checkbox" id="multipleMotarCheckbox" 
                                    class="w-5 h-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                <div class="flex-1">
                                    <label for="multipleMotarCheckbox" class="text-sm font-semibold text-gray-800 cursor-pointer">Multiple Motar</label>
                                    <p class="text-xs text-gray-500">Enable to enter multiple motars separated by comma (e.g., 23456,56789)</p>
                                </div>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700" id="motarInputLabel">Enter Number (4-10
                                    digits)</label>
                                <input type="text" id="motarNumberInput" placeholder="e.g. 4789" maxlength="10"
                                    class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" />
                                <p class="text-xs text-gray-500 mt-1" id="motarInputHint">Enter 4-10 digit number. Only digits 0-9 allowed.
                                </p>
                            </div>
                            <div id="motarGeneratedNumbers" class="hidden">
                                <label class="block mb-2 text-sm font-medium text-gray-700">Generated 3-Digit
                                    Numbers:</label>
                                <div id="motarNumbersList"
                                    class="p-3 bg-orange-50 border-2 border-orange-200 rounded-lg max-h-60 overflow-y-auto">
                                    <div class="flex flex-wrap gap-2" id="motarNumbersDisplay"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span id="motarNumbersCount">0</span> numbers will be generated
                                </p>
                            </div>
                        </div>
                        <!-- Comman Pana Options -->
                        <div id="commanPanaOptions" class="hidden space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Common Bet
                                    Type</label>
                                <div class="space-y-2">
                                    <label
                                        class="flex items-center space-x-3 cursor-pointer p-3 border-2 border-gray-300 rounded-lg hover:bg-blue-50 transition">
                                        <input type="checkbox" id="commanPana36Checkbox" value="36"
                                            class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <div class="flex-1">
                                            <span class="text-sm font-semibold text-gray-800">Common Pana 36</span>
                                            <p class="text-xs text-gray-500">Find numbers from SP only (36 numbers max)
                                            </p>
                                        </div>
                                    </label>
                                    <label
                                        class="flex items-center space-x-3 cursor-pointer p-3 border-2 border-gray-300 rounded-lg hover:bg-blue-50 transition">
                                        <input type="checkbox" id="commanPana56Checkbox" value="56"
                                            class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <div class="flex-1">
                                            <span class="text-sm font-semibold text-gray-800">Common Pana 56</span>
                                            <p class="text-xs text-gray-500">Find numbers from SP + DP (56 numbers max)
                                            </p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Enter Single Digit
                                    (0-9)</label>
                                <input type="text" id="commanPanaDigitInput" placeholder="e.g. 4" maxlength="1"
                                    class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                <p class="text-xs text-gray-500 mt-1">Enter a single digit (0-9). System will find
                                    matching numbers based on selected type.</p>
                            </div>
                            <div id="commanPanaGeneratedNumbers" class="hidden">
                                <label class="block mb-2 text-sm font-medium text-gray-700">Found Numbers:</label>
                                <div id="commanPanaNumbersList"
                                    class="p-3 bg-blue-50 border-2 border-blue-200 rounded-lg max-h-48 overflow-y-auto">
                                    <div class="flex flex-wrap gap-2" id="commanPanaNumbersDisplay"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span id="commanPanaNumbersCount">0</span> numbers contain this digit
                                </p>
                            </div>
                        </div>
                        <!-- Set Pana Options -->
                        <div id="setPanaOptions" class="hidden space-y-4">
                            <div class="p-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg">
                                <!-- Multiple Set Pana Checkbox -->
                                <div class="mb-3 flex items-center gap-2 px-2 py-2 bg-violet-50 rounded-lg border border-violet-200">
                                    <input type="checkbox" id="multipleSetPanaCheckbox"
                                        class="w-4 h-4 text-violet-600 rounded focus:ring-2 focus:ring-violet-500">
                                    <label for="multipleSetPanaCheckbox" class="text-xs font-medium text-gray-700 cursor-pointer">
                                        Multiple Set Pana (comma separated)
                                    </label>
                                </div>
                                <div>
                                    <label id="setPanaInputLabel" class="block mb-2 text-sm font-medium text-gray-700">Enter 3-Digit Number</label>
                                    <input type="text" id="setPanaNumberInput" placeholder="e.g. 115, 156, 660"
                                        maxlength="3"
                                        class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                                    <p id="setPanaInputHint" class="text-xs text-gray-500 mt-1">Enter any 3-digit number from a family group
                                        (e.g., 115, 156, 110 are all in G17)</p>
                                </div>
                            </div>
                            <div id="setPanaFamilyInfo" class="hidden">
                                <div class="p-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg">
                                    <p class="text-sm font-semibold text-indigo-800 mb-2">
                                        Family: <span id="setPanaFamilyName" class="text-indigo-600"></span>
                                    </p>
                                    <label class="block mb-2 text-xs font-medium text-gray-700">All numbers in this
                                        family:</label>
                                    <div class="flex flex-wrap gap-2 max-h-60 overflow-y-auto" id="setPanaFamilyNumbers"></div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        <span id="setPanaFamilyCount">0</span> numbers in this family
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Group Bet Options -->
                        <div id="groupBetOptions" class="hidden space-y-4">
                            <div class="p-4 bg-purple-50 border-2 border-purple-200 rounded-lg">
                                <!-- Multiple Group Checkbox -->
                                <div class="mb-3 flex items-center gap-2 px-2 py-2 bg-rose-50 rounded-lg border border-rose-200">
                                    <input type="checkbox" id="multipleGroupCheckbox"
                                        class="w-4 h-4 text-rose-600 rounded focus:ring-2 focus:ring-rose-500">
                                    <label for="multipleGroupCheckbox" class="text-xs font-medium text-gray-700 cursor-pointer">
                                        Multiple Group (comma separated)
                                    </label>
                                </div>
                                <div>
                                    <label id="groupInputLabel" class="block mb-2 text-xs font-medium text-gray-700">Enter Two Digits (e.g., 35, 99, 07)</label>
                                    <input type="text" id="groupBetDigitsInput" maxlength="2" minlength="2"
                                        class="w-full px-3 py-3 text-center text-2xl font-bold border-2 border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        placeholder="00">
                                    <p id="groupInputHint" class="text-xs text-gray-500 mt-1">Enter exactly 2 digits (0-9). First digit and second digit will be used for matching.</p>
                                </div>
                                <div class="mt-4 p-3 bg-white border border-purple-200 rounded-lg">
                                    <p class="text-xs font-medium text-gray-700 mb-2">Preview matching numbers:</p>
                                    <div id="groupBetPreview" class="text-xs text-gray-600 max-h-60 overflow-y-auto">
                                        Enter two digits to see matching numbers
                                    </div>
                                    <p class="text-xs text-purple-600 mt-2">
                                        Total: <span id="groupBetCount" class="font-bold">0</span> numbers
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Column Bet Options -->
                        <div id="columnBetOptions" class="hidden space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Select Column(s)</label>
                                <div class="grid grid-cols-5 gap-2">
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="1"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">1</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="2"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">2</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="3"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">3</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="4"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">4</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="5"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">5</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="6"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">6</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="7"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">7</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="8"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">8</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="9"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">9</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-2 cursor-pointer p-2 border-2 border-gray-300 rounded-lg hover:bg-emerald-50 transition">
                                        <input type="checkbox" value="10"
                                            class="columnBetCheckbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                        <span class="text-sm font-medium">10</span>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Select one or more columns to place bets</p>
                            </div>
                        </div>
                        <!-- Select All Columns Checkbox (for Jodi, Dadar, ABR Cut, Jodi Panel) -->
                        <div id="selectAllColumnsContainer" class="hidden mb-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="selectAllColumnsCheckbox"
                                    class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                                <span class="text-sm font-medium text-gray-700">Select All Columns (1-10)</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-7">Check this to place bets on all 10 columns</p>
                        </div>
                        <!-- Amount Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick amounts:</label>
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                <button class="amount-button" data-amount="1">1</button>
                                <button class="amount-button" data-amount="2">2</button>
                                <button class="amount-button" data-amount="2.5">2.5</button>
                                <button class="amount-button" data-amount="5">5</button>
                            </div>
                            <div class="relative my-4">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">OR</span>
                                </div>
                            </div>
                            <label for="customAmount" class="block text-sm font-medium text-gray-700 mb-2">Custom
                                amount:</label>
                            <input type="number" id="customAmount" placeholder="e.g. 1, 123, 246..." min="1" max="5000"
                                step="1"
                                class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                            <p class="text-xs text-gray-500 mt-1">Min: 1 | Max: 5,000 | Any amount allowed</p>
                        </div>
                        <!-- Action Buttons -->
                        <div class="space-y-2 pt-2">
                            <div class="flex gap-2">
                                <button id="cancelBtn"
                                    class="flex-1 px-4 py-2 bg-gray-300 rounded-lg text-gray-800 font-semibold hover:bg-gray-400 transition">Cancel</button>
                                <button id="confirmBtn"
                                    class="flex-1 px-4 py-2 bg-indigo-600 rounded-lg text-white font-semibold hover:bg-indigo-700 transition">Place
                                    Bet</button>
                            </div>
                            <button id="undoBtn"
                                class="w-full px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition hidden">
                                Undo Last Action
                            </button>
                        </div>
                    </div>
                </div>
                <!-- History Content -->
                <div id="historyContent" class="hidden">
                    <div id="historyList" class="space-y-2">
                        <div class="p-4 text-center text-gray-500">
                            No history available
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        /* eslint-disable */
        // Django template variables - rendered server-side before JavaScript execution
        const bazarNamesJSON = {{ bazar_names_json|safe }};
        const rowLabelsJSON = {{ row_labels|safe }};
        const allColumnDataJSON = {{ ALL_COLUMN_DATA|safe }};
        /* eslint-enable */

        // ========== PERFORMANCE UTILITIES ==========
        // Debounce function - prevents rapid repeated calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function - limits execution rate
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // Run non-critical tasks when browser is idle
        function runWhenIdle(callback) {
            if ('requestIdleCallback' in window) {
                requestIdleCallback(callback, { timeout: 2000 });
            } else {
                setTimeout(callback, 100);
            }
        }

        // Batch DOM updates using requestAnimationFrame
        const pendingUpdates = [];
        let updateScheduled = false;
        function batchDOMUpdate(updateFn) {
            pendingUpdates.push(updateFn);
            if (!updateScheduled) {
                updateScheduled = true;
                requestAnimationFrame(() => {
                    const updates = pendingUpdates.splice(0);
                    updates.forEach(fn => fn());
                    updateScheduled = false;
                });
            }
        }

        // Lazy feature initialization tracker
        const initializedFeatures = new Set();
        function initFeatureOnce(featureName, initFn) {
            if (!initializedFeatures.has(featureName)) {
                initializedFeatures.add(featureName);
                initFn();
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const API = {
                PLACE_BET: '/place-bet/',
                PLACE_BULK: '/place-bulk-bet/',
                LOAD_BETS: '/load-bets/',
                DELETE_BET: '/delete-bet/',
                UNDO_BULK: '/undo-bulk-action/',
                GET_LAST_BULK: '/get-last-bulk-action/',
                GET_BET_TOTAL: '/get-bet-total/',
                GET_ALL_BET_TOTALS: '/get-all-bet-totals/',
                GENERATE_MOTAR: '/generate-motar-numbers/',
                FIND_COMMAN_PANA: '/find-comman-pana-numbers/',
                PLACE_MOTAR: '/place-motar-bet/',
                PLACE_COMMAN_PANA: '/place-comman-pana-bet/',
                PLACE_SET_PANA: '/place-set-pana-bet/',
                PLACE_GROUP: '/place-group-bet/',
                GET_BULK_HISTORY: '/get-bulk-action-history/',
                GET_DATABASE_STORAGE: '/get-database-storage/',
                PLACE_COLUMN_BET: '/place-column-bet/',
                GET_COLUMN_TOTALS: '/get-column-totals/',
                DELETE_BAZAR_BETS: '/delete-bazar-bets/',
            };
            // Restore last selected bazar from localStorage, or use default
            let currentBazar = localStorage.getItem('selectedBazar') || '{{ bazar_choices.0.value }}';
            let currentDate = '{{ current_date }}';
            const bazarNames = bazarNamesJSON;
            const rowLabels = rowLabelsJSON;
            const allColumnData = allColumnDataJSON;
            let bets = {};
            window.bets = bets; // Make bets globally accessible
            let currentNumber = null;
            let currentBetType = null; // 'SINGLE', 'SP', 'DP', 'JODI', 'DADAR', 'EKI_BEKI', 'ABR_CUT'
            let lastBulkAction = null;
            let selectedAbrColumns = []; // Array to store selected columns for multi-selection
            let lastMotarBets = []; // Track last Motar bet IDs for undo
            let lastCommanPanaBets = []; // Track last Comman Pana bet IDs for undo
            let currentPage = 1; // Initialize current page to 1 (All SP)
            let spAmountLimit = null; // SP amount limit for highlighting
            let dpAmountLimit = null; // DP amount limit for highlighting
            const loaderOverlay = document.getElementById('loaderOverlay');
            const loaderText = document.getElementById('loaderText');
            function showLoader(text = 'Loading...') {
                loaderOverlay.classList.add('active');
                document.body.classList.add('loading');
                loaderText.textContent = text;
            }
            function updateLoader(text) {
                if (text) {
                    loaderText.textContent = text;
                }
            }
            function hideLoader() {
                loaderOverlay.classList.remove('active');
                document.body.classList.remove('loading');
                loaderText.textContent = 'Loading...';
            }
            const modal = document.getElementById('universalModal');
            const closeModalBtn = document.getElementById('closeModal');
            const modalTitle = document.getElementById('modalTitle');
            const placeTab = document.getElementById('placeTab');
            const historyTab = document.getElementById('historyTab');
            const placeContent = document.getElementById('placeContent');
            const historyContent = document.getElementById('historyContent');
            const historyList = document.getElementById('historyList');
            const cancelBtn = document.getElementById('cancelBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const undoBtn = document.getElementById('undoBtn');
            const customAmountInput = document.getElementById('customAmount');
            const amountButtons = document.querySelectorAll('.amount-button');
            const columnOptions = document.getElementById('columnOptions');
            const dadarOptions = document.getElementById('dadarOptions');
            const jodiOptions = document.getElementById('jodiOptions');
            const ekiBekiOptions = document.getElementById('ekiBekiOptions');
            const abrCutOptions = document.getElementById('abrCutOptions');
            const jodiPanelOptions = document.getElementById('jodiPanelOptions');
            const motarOptions = document.getElementById('motarOptions');
            const commanPanaOptions = document.getElementById('commanPanaOptions');
            const setPanaOptions = document.getElementById('setPanaOptions');
            const tbody = document.getElementById('spreadsheet-body');
            function getCSRFToken() {
                return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            }
            function showToast(title, message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icons = {
                    success: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>',
                    error: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
                    warning: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
                };
                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || icons.success}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">&times;</button>
                `;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                const timeoutId = setTimeout(() => removeToast(toast), 3000);
                toast.querySelector('.toast-close').onclick = () => {
                    clearTimeout(timeoutId);
                    removeToast(toast);
                };
            }
            function removeToast(toast) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }
            // Open Modal Function
            function openModal(betType, number = null, title = 'Place a Bet') {
                currentBetType = betType;
                currentNumber = number;
                modal.classList.remove('hidden');
                modalTitle.textContent = title;
                customAmountInput.value = '';
                amountButtons.forEach(b => b.classList.remove('selected'));
                selectedAbrColumns = [];
                // Uncheck all checkboxes
                document.querySelectorAll('.betColumnCheckbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.jodiColumnCheckbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.abrCutColumnCheckbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.jodiPanelColumnCheckbox').forEach(cb => cb.checked = false);
                const selectAllCheckbox = document.getElementById('selectAllColumnsCheckbox');
                selectAllCheckbox.checked = false;
                // Show/hide specific options
                columnOptions.classList.add('hidden');
                jodiOptions.classList.add('hidden');
                ekiBekiOptions.classList.add('hidden');
                abrCutOptions.classList.add('hidden');
                jodiPanelOptions.classList.add('hidden');
                motarOptions.classList.add('hidden');
                commanPanaOptions.classList.add('hidden');
                setPanaOptions.classList.add('hidden');
                document.getElementById('columnBetOptions').classList.add('hidden');
                document.getElementById('groupBetOptions').classList.add('hidden');
                document.getElementById('groupBetOptions').classList.add('hidden');
                if (motarOptions) {
                    document.getElementById('motarNumberInput').value = '';
                    document.getElementById('motarGeneratedNumbers').classList.add('hidden');
                }
                if (commanPanaOptions) {
                    document.getElementById('commanPanaDigitInput').value = '';
                    document.getElementById('commanPanaGeneratedNumbers').classList.add('hidden');
                }
                document.getElementById('setPanaNumberInput').value = '';
                document.getElementById('setPanaFamilyInfo').classList.add('hidden');
                // Show/hide "Select All Columns" checkbox (only for JODI, ABR_CUT, JODI_PANEL)
                // Note: DADAR is now part of EKI_BEKI dropdown, so it's handled differently
                const selectAllContainer = document.getElementById('selectAllColumnsContainer');
                if (['JODI', 'ABR_CUT', 'JODI_PANEL'].includes(betType)) {
                    selectAllContainer.classList.remove('hidden');
                } else {
                    selectAllContainer.classList.add('hidden');
                }
                if (betType === 'SINGLE' || betType === 'SP' || betType === 'DP') {
                    columnOptions.classList.remove('hidden');
                } else if (betType === 'JODI') {
                    jodiOptions.classList.remove('hidden');
                } else if (betType === 'EKI_BEKI') {
                    ekiBekiOptions.classList.remove('hidden');
                } else if (betType === 'ABR_CUT') {
                    abrCutOptions.classList.remove('hidden');
                } else if (betType === 'JODI_PANEL') {
                    jodiPanelOptions.classList.remove('hidden');
                } else if (betType === 'MOTAR') {
                    motarOptions.classList.remove('hidden');
                } else if (betType === 'COMMAN_PANA') {
                    commanPanaOptions.classList.remove('hidden');
                } else if (betType === 'SET_PANA') {
                    setPanaOptions.classList.remove('hidden');
                    selectAllContainer.classList.add('hidden');
                } else if (betType === 'COLUMN') {
                    document.getElementById('columnBetOptions').classList.remove('hidden');
                    selectAllContainer.classList.add('hidden');
                } else if (betType === 'GROUP') {
                    document.getElementById('groupBetOptions').classList.remove('hidden');
                    selectAllContainer.classList.add('hidden');
                    // Clear group bet input
                    document.getElementById('groupBetDigitsInput').value = '';
                    document.getElementById('groupBetPreview').textContent = 'Enter two digits to see matching numbers';
                    document.getElementById('groupBetCount').textContent = '0';
                }
                switchToPlaceTab();
                updateUndoButton();
            }
            // Close Modal Function
            function closeModal() {
                modal.classList.add('hidden');
                currentBetType = null;
                currentNumber = null;
                selectedAbrColumns = [];
                // Uncheck all checkboxes
                document.querySelectorAll('.betColumnCheckbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.jodiColumnCheckbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.abrCutColumnCheckbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.jodiPanelColumnCheckbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.columnBetCheckbox').forEach(cb => cb.checked = false);
                document.getElementById('motarNumberInput').value = '';
                document.getElementById('motarGeneratedNumbers').classList.add('hidden');
                // Reset multiple motar checkbox and input state
                const multipleMotarCheckbox = document.getElementById('multipleMotarCheckbox');
                if (multipleMotarCheckbox) {
                    multipleMotarCheckbox.checked = false;
                    const motarInput = document.getElementById('motarNumberInput');
                    motarInput.placeholder = 'e.g. 4789';
                    motarInput.maxLength = 10;
                    document.getElementById('motarInputLabel').textContent = 'Enter Number (4-10 digits)';
                    document.getElementById('motarInputHint').textContent = 'Enter 4-10 digit number. Only digits 0-9 allowed.';
                }
                // Reset multiple group checkbox and input state
                const multipleGroupCheckbox = document.getElementById('multipleGroupCheckbox');
                if (multipleGroupCheckbox) {
                    multipleGroupCheckbox.checked = false;
                    const groupInput = document.getElementById('groupBetDigitsInput');
                    groupInput.placeholder = '00';
                    groupInput.maxLength = 2;
                    document.getElementById('groupInputLabel').textContent = 'Enter Two Digits (e.g., 35, 99, 07)';
                    document.getElementById('groupInputHint').textContent = 'Enter exactly 2 digits (0-9). First digit and second digit will be used for matching.';
                }
                document.getElementById('groupBetDigitsInput').value = '';
                document.getElementById('groupBetPreview').textContent = 'Enter two digits to see matching numbers';
                document.getElementById('groupBetCount').textContent = '0';
                // Reset multiple set pana checkbox and input state
                const multipleSetPanaCheckbox = document.getElementById('multipleSetPanaCheckbox');
                if (multipleSetPanaCheckbox) {
                    multipleSetPanaCheckbox.checked = false;
                    const setPanaInput = document.getElementById('setPanaNumberInput');
                    setPanaInput.placeholder = 'e.g. 115, 156, 660';
                    setPanaInput.maxLength = 3;
                    document.getElementById('setPanaInputLabel').textContent = 'Enter 3-Digit Number';
                    document.getElementById('setPanaInputHint').textContent = 'Enter any 3-digit number from a family group (e.g., 115, 156, 110 are all in G17)';
                }
                document.getElementById('setPanaNumberInput').value = '';
                document.getElementById('setPanaFamilyInfo').classList.add('hidden');
                const selectAllCheckbox = document.getElementById('selectAllColumnsCheckbox');
                selectAllCheckbox.checked = false;
            }
            function getSelectedColumns(checkboxClass) {
                const selected = [];
                document.querySelectorAll(`.${checkboxClass}:checked`).forEach(cb => {
                    selected.push(parseInt(cb.value));
                });
                return selected;
            }
            function switchToPlaceTab() {
                placeContent.classList.remove('hidden');
                historyContent.classList.add('hidden');
                placeTab.classList.add('border-indigo-600', 'text-indigo-600');
                historyTab.classList.remove('border-indigo-600', 'text-indigo-600');
            }
            function switchToHistoryTab() {
                placeContent.classList.add('hidden');
                historyContent.classList.remove('hidden');
                historyTab.classList.add('border-indigo-600', 'text-indigo-600');
                placeTab.classList.remove('border-indigo-600', 'text-indigo-600');
                renderHistory();
            }
            function updateUndoButton() {
                if (currentBetType === 'MOTAR' && lastMotarBets.length > 0) {
                    undoBtn.textContent = `Undo Last Motar (${lastMotarBets.length} bets)`;
                    undoBtn.classList.remove('hidden');
                    return;
                }
                if (currentBetType === 'COMMAN_PANA' && lastCommanPanaBets.length > 0) {
                    undoBtn.textContent = `Undo Last Comman Pana (${lastCommanPanaBets.length} bets)`;
                    undoBtn.classList.remove('hidden');
                    return;
                }
                undoBtn.textContent = 'Undo Last Action';
                if (lastBulkAction && ['SP', 'DP', 'JODI', 'DADAR', 'EKI_BEKI', 'ABR_CUT', 'JODI_PANEL', 'GROUP', 'SET_PANA'].includes(currentBetType)) {
                    if (currentBetType === 'EKI_BEKI') {
                        const selectedType = document.getElementById('ekiBekiType').value;
                        if (lastBulkAction.type === selectedType) {
                            undoBtn.classList.remove('hidden');
                            return;
                        }
                    } else {
                        // For SP, DP, JODI, DADAR, ABR_CUT, JODI_PANEL - show if last action matches current type
                        if (lastBulkAction.type === currentBetType) {
                            undoBtn.classList.remove('hidden');
                            return;
                        }
                    }
                }
                undoBtn.classList.add('hidden');
            }
            function renderHistory() {
                historyList.innerHTML = '';
                let relevantBets = [];
                if (currentBetType === 'SINGLE') {
                    const history = bets[currentNumber]?.history || [];
                    if (history.length === 0) {
                        historyList.innerHTML = '<div class="p-4 text-center text-gray-500">No bets yet.</div>';
                        return;
                    }
                    history.forEach((bet, i) => {
                        const li = document.createElement('li');
                        li.classList.add('flex', 'flex-col', 'bg-gray-50', 'p-3', 'rounded', 'gap-1');
                        const mainRow = document.createElement('div');
                        mainRow.classList.add('flex', 'justify-between', 'items-center');
                        const infoDiv = document.createElement('div');
                        infoDiv.classList.add('flex', 'flex-col');
                        const amountText = document.createElement('span');
                        amountText.classList.add('font-semibold');
                        amountText.textContent = `${bet.amount}`;
                        const metaText = document.createElement('span');
                        metaText.classList.add('text-xs', 'text-gray-500');
                        metaText.textContent = `${bet.created_at} ‚Ä¢ ${bet.bet_type || 'SINGLE'}`;
                        infoDiv.append(amountText, metaText);
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Delete';
                        delBtn.classList.add('delete-button');
                        delBtn.onclick = async () => {
                            await deleteBet(bet.id, currentNumber);
                            renderHistory();
                        };
                        mainRow.append(infoDiv, delBtn);
                        li.appendChild(mainRow);
                        historyList.appendChild(li);
                    });
                } else if (currentBetType === 'DADAR') {
                    const dadarNumbers = new Set([678, 345, 120, 789, 456, 123, 890, 567, 234, 190].map(String));
                    relevantBets = Object.entries(bets)
                        .filter(([number]) => dadarNumbers.has(number))
                        .flatMap(([number, data]) =>
                            data.history.map(bet => ({
                                ...bet,
                                number
                            }))
                        );
                    if (relevantBets.length === 0) {
                        historyList.innerHTML = '<div class="p-4 text-center text-gray-500">No Dadar bets found</div>';
                        return;
                    }
                    relevantBets.forEach((bet) => {
                        const li = document.createElement('li');
                        li.className = 'flex flex-col bg-gray-50 p-3 rounded gap-1';
                        const mainRow = document.createElement('div');
                        mainRow.className = 'flex justify-between items-center';
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'flex flex-col';
                        const numberAmount = document.createElement('span');
                        numberAmount.className = 'font-semibold';
                        numberAmount.textContent = `${bet.number}: ${bet.amount}`;
                        const metaText = document.createElement('span');
                        metaText.className = 'text-xs text-gray-500';
                        const columnInfo = bet.column ? `Col ${bet.column} ‚Ä¢ ` : '';
                        metaText.textContent = `${bet.created_at} ‚Ä¢ ${columnInfo}${bet.bet_type || 'DADAR'}`;
                        infoDiv.append(numberAmount, metaText);
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Delete';
                        delBtn.className = 'delete-button';
                        delBtn.onclick = async () => {
                            await deleteBet(bet.id, bet.number);
                            renderHistory();
                        };
                        mainRow.append(infoDiv, delBtn);
                        li.appendChild(mainRow);
                        historyList.appendChild(li);
                    });
                } else if (currentBetType === 'EKI_BEKI') {
                    const ekiBekiType = document.getElementById('ekiBekiType').value;
                    let targetNumbers;
                    if (ekiBekiType === 'EKI') {
                        targetNumbers = new Set([137, 135, 139, 157, 159, 179, 357, 359, 379, 579].map(String));
                    } else if (ekiBekiType === 'BEKI') {
                        targetNumbers = new Set([246, 248, 240, 268, 260, 280, 468, 460, 480, 680].map(String));
                    } else if (ekiBekiType === 'DADAR') {
                        targetNumbers = new Set([100, 110, 112, 113, 114, 115, 116, 117, 118, 119].map(String));
                    }
                    relevantBets = Object.entries(bets)
                        .filter(([number]) => targetNumbers.has(number))
                        .flatMap(([number, data]) =>
                            data.history.map(bet => ({
                                ...bet,
                                number
                            }))
                        );
                    if (relevantBets.length === 0) {
                        historyList.innerHTML = `<div class="p-4 text-center text-gray-500">No ${ekiBekiType} bets found</div>`;
                        return;
                    }
                    relevantBets.forEach((bet) => {
                        const li = document.createElement('li');
                        li.className = 'flex flex-col bg-gray-50 p-3 rounded gap-1';
                        const mainRow = document.createElement('div');
                        mainRow.className = 'flex justify-between items-center';
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'flex flex-col';
                        const numberAmount = document.createElement('span');
                        numberAmount.className = 'font-semibold';
                        numberAmount.textContent = `${bet.number}: ${bet.amount}`;
                        const metaText = document.createElement('span');
                        metaText.className = 'text-xs text-gray-500';
                        metaText.textContent = `${bet.created_at} ‚Ä¢ ${bet.sub_type || bet.bet_type || ekiBekiType}`;
                        infoDiv.append(numberAmount, metaText);
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Delete';
                        delBtn.className = 'delete-button';
                        delBtn.onclick = async () => {
                            await deleteBet(bet.id, bet.number);
                            renderHistory();
                        };
                        mainRow.append(infoDiv, delBtn);
                        li.appendChild(mainRow);
                        historyList.appendChild(li);
                    });
                } else {
                    historyList.innerHTML = '<div class="p-4 text-center text-gray-500">No history available</div>';
                }
            }
            async function loadBets() {
                try {
                    const res = await fetch(`${API.LOAD_BETS}?bazar=${currentBazar}&date=${currentDate}`);
                    const data = await res.json();
                    if (data.success) {
                        bets = data.bets;
                        renderPage(currentPage);
                    } else {
                        console.error('Load bets failed:', data);
                    }
                } catch (err) {
                    console.error('Error loading bets:', err);
                    throw err; // Re-throw to be caught by Promise.allSettled
                }
            }
            async function getLastBulkAction() {
                try {
                    const res = await fetch(`${API.GET_LAST_BULK}?bazar=${currentBazar}&date=${currentDate}`);
                    const data = await res.json();
                    lastBulkAction = data.has_action ? data.action : null;
                    updateUndoButton();
                } catch (err) {
                    console.error('Error getting last bulk:', err);
                    throw err; // Re-throw to be caught by Promise.allSettled
                }
            }
            async function placeSingleBet(number, amount) {
                showLoader('Placing bet...');
                try {
                    updateLoader('Processing request...');
                    const res = await fetch(API.PLACE_BET, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                        body: JSON.stringify({ number, amount, bazar: currentBazar, date: currentDate })
                    });
                    updateLoader('Saving bet...');
                    const data = await res.json();
                    if (data.success) {
                        if (!bets[number]) bets[number] = { total: 0, history: [] };
                        bets[number].total += parseFloat(amount);
                        bets[number].history.push({ id: data.bet_id, amount: parseFloat(amount) });
                        updateBetTotal(number);
                        updateLoader('Complete!');
                    }
                    return data;
                } finally {
                    setTimeout(() => hideLoader(), 300);
                }
            }
            async function placeBulkBet(type, amount, column = null, jodiType = null, panelType = null) {
                showLoader(`Placing ${type} bets...`);
                try {
                    const payload = { type, amount, bazar: currentBazar, date: currentDate };
                    updateLoader('Preparing data...');
                    if (type === 'JODI') {
                        payload.columns = Array.isArray(column) ? column : [column];
                        payload.jodi_type = jodiType;
                    } else if (type === 'DADAR') {
                        payload.columns = Array.isArray(column) ? column : [column];
                    } else if (type === 'SINGLE' || type === 'SP' || type === 'DP') {
                        if (column !== null) {
                            payload.columns = Array.isArray(column) ? column : [column];
                        }
                    } else if (type === 'ABR_CUT') {
                        payload.columns = Array.isArray(column) ? column : [column];
                    } else if (type === 'JODI_PANEL') {
                        payload.columns = Array.isArray(column) ? column : [column];
                        payload.panel_type = panelType;
                    }
                    updateLoader('Sending request...');
                    const res = await fetch(API.PLACE_BULK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                        body: JSON.stringify(payload)
                    });
                    updateLoader('Processing bets...');
                    const data = await res.json();
                    if (data.success) {
                        updateLoader('Updating totals...');
                        data.bets.forEach(bet => {
                            const num = bet.number;
                            if (!bets[num]) bets[num] = { total: 0, history: [] };
                            bets[num].total += parseFloat(bet.amount);
                            bets[num].history.push({ id: bet.id, amount: parseFloat(bet.amount) });
                            updateBetTotal(num);
                        });
                        lastBulkAction = { id: data.bulk_action_id, type, total_bets: data.total_bets };
                        updateLoader('Complete!');
                    }
                    return data;
                } finally {
                    setTimeout(() => hideLoader(), 300);
                }
            }
            async function deleteBet(betId, number) {
                const res = await fetch(API.DELETE_BET, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ bet_id: betId })
                });
                const data = await res.json();
                if (data.success) {
                    const hist = bets[number]?.history;
                    if (hist) {
                        const idx = hist.findIndex(h => h.id === betId);
                        if (idx !== -1) {
                            bets[number].total -= hist[idx].amount;
                            hist.splice(idx, 1);
                        }
                        if (hist.length === 0) delete bets[number];
                    }
                    updateBetTotal(number);
                    await refreshAllBetTotals();
                }
                return data;
            }
            async function undoBulkAction() {
                if (currentBetType === 'MOTAR' && lastMotarBets.length > 0) {
                    if (!confirm(`Undo last Motar action (${lastMotarBets.length} bets)?`)) return;
                    let successCount = 0;
                    let failCount = 0;
                    for (const bet of lastMotarBets) {
                        const result = await deleteBet(bet.bet_id, bet.number);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                    if (successCount > 0) {
                        showToast('Success', `${successCount} Motar bets undone`, 'success');
                        lastMotarBets = []; // Clear tracked bets
                        await updateTotalAmount();
                        renderPage(1);
                        updateUndoButton(); // Hide undo button
                    }
                    if (failCount > 0) {
                        showToast('Warning', `Failed to undo ${failCount} bets`, 'warning');
                    }
                    return;
                }
                if (currentBetType === 'COMMAN_PANA' && lastCommanPanaBets.length > 0) {
                    if (!confirm(`Undo last Comman Pana action (${lastCommanPanaBets.length} bets)?`)) return;
                    let successCount = 0;
                    let failCount = 0;
                    for (const bet of lastCommanPanaBets) {
                        const result = await deleteBet(bet.bet_id, bet.number);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                    if (successCount > 0) {
                        showToast('Success', `${successCount} Comman Pana bets undone`, 'success');
                        lastCommanPanaBets = []; // Clear tracked bets
                        await updateTotalAmount();
                        renderPage(1);
                        updateUndoButton(); // Hide undo button
                    }
                    if (failCount > 0) {
                        showToast('Warning', `Failed to undo ${failCount} bets`, 'warning');
                    }
                    return;
                }
                if (!lastBulkAction) return showToast('Error', 'No bulk action to undo', 'warning');
                if (!confirm(`Undo last ${lastBulkAction.type} bulk action (${lastBulkAction.total_bets} bets)?`)) return;
                const res = await fetch(API.UNDO_BULK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
                    body: JSON.stringify({ bulk_action_id: lastBulkAction.id })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Success', data.message, 'success');
                    await loadBets();
                    await refreshAllBetTotals();
                    lastBulkAction = null;
                    await getLastBulkAction();
                    await updateTotalAmount();
                    closeModal();
                } else {
                    showToast('Error', data.message || 'Failed to undo', 'error');
                }
            }
            async function updateTotalAmount() {
                try {
                    const res = await fetch(`${API.GET_BET_TOTAL}?bazar=${currentBazar}&date=${currentDate}`);
                    const data = await res.json();
                    if (data.success) {
                        const totalAmount = parseFloat(data.total_amount).toLocaleString('en-IN');
                        const totalElement = document.getElementById('totalBalance');
                        const totalElementMobile = document.getElementById('totalBalanceMobile');
                        if (totalElement) totalElement.textContent = totalAmount;
                        if (totalElementMobile) totalElementMobile.textContent = totalAmount;
                    }
                } catch (err) {
                    console.error('Error fetching total amount:', err);
                }
            }

            // Cache for bet total elements to avoid repeated DOM queries
            const betTotalElementCache = new Map();
            function getBetTotalElement(number) {
                if (!betTotalElementCache.has(number)) {
                    betTotalElementCache.set(number, document.getElementById(`bet-total-${number}`));
                }
                return betTotalElementCache.get(number);
            }

            function updateBetTotal(number) {
                const el = getBetTotalElement(number);
                if (el) {
                    el.textContent = bets[number]?.total ? `${bets[number].total}` : '';
                }
            }

            // Batch update bet totals for better performance
            function updateAllBetTotals() {
                batchDOMUpdate(() => {
                    for (const number in bets) {
                        updateBetTotal(number);
                    }
                    highlightCellsByLimit();
                });
            }

            async function refreshAllBetTotals() {
                try {
                    const res = await fetch(`${API.GET_ALL_BET_TOTALS}?bazar=${currentBazar}&date=${currentDate}`);
                    const data = await res.json();
                    if (data.success) {
                        const dbTotals = data.bet_totals;
                        for (const number in bets) {
                            bets[number].total = 0;
                        }
                        for (const number in dbTotals) {
                            if (!bets[number]) {
                                bets[number] = { total: 0, history: [] };
                            }
                            bets[number].total = dbTotals[number];
                        }
                        updateAllBetTotals();
                    }
                } catch (err) {
                    console.error('Error refreshing bet totals:', err);
                }
            }
            async function refreshColumnTotals() {
                try {
                    const res = await fetch(`${API.GET_COLUMN_TOTALS}?bazar=${currentBazar}&date=${currentDate}`);
                    const data = await res.json();
                    if (data.success) {
                        const columnTotals = data.column_totals;
                        for (let col = 1; col <= 10; col++) {
                            const totalSpan = document.getElementById(`column-total-${col}`);
                            if (totalSpan) {
                                const total = columnTotals[col] || 0;
                                totalSpan.textContent = total > 0 ? total : '';
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error refreshing column totals:', err);
                }
            }
            function renderPage(page) {
                tbody.innerHTML = '';
                const start = page === 1 ? 0 : 13;
                const end = page === 1 ? 11 : 22;
                currentPage = page;
                const page1Btn = document.getElementById('page-1-btn');
                const page2Btn = document.getElementById('page-2-btn');
                if (page === 1) {
                    page1Btn.classList.add('bg-indigo-600', 'text-white');
                    page1Btn.classList.remove('bg-gray-300', 'text-gray-800');
                    page2Btn.classList.add('bg-gray-300', 'text-gray-800');
                    page2Btn.classList.remove('bg-indigo-600', 'text-white');
                } else {
                    page2Btn.classList.add('bg-indigo-600', 'text-white');
                    page2Btn.classList.remove('bg-gray-300', 'text-gray-800');
                    page1Btn.classList.add('bg-gray-300', 'text-gray-800');
                    page1Btn.classList.remove('bg-indigo-600', 'text-white');
                }
                for (let i = start; i <= end; i++) {
                    const row = document.createElement('tr');
                    const dataIndex = i > 12 ? i - 1 : i;
                    const rowNum = document.createElement('td');
                    rowNum.textContent = rowLabels[dataIndex] || (dataIndex + 1);
                    rowNum.classList.add('spreadsheet-cell', 'row-number-cell');
                    row.appendChild(rowNum);
                    for (let j = 0; j < 10; j++) {
                        const cell = document.createElement('td');
                        cell.classList.add('spreadsheet-cell', 'text-gray-700');
                        const value = allColumnData[j][dataIndex];
                        if (value) {
                            const span = document.createElement('span');
                            span.textContent = value;
                            span.style.fontWeight = '600';
                            const plus = document.createElement('button');
                            plus.textContent = '+';
                            plus.classList.add('bet-button');
                            plus.onclick = () => openModal('SINGLE', value, `Place a Bet on ${value}`);
                            const total = document.createElement('span');
                            total.classList.add('ml-2', 'text-sm', 'font-semibold', 'text-green-600');
                            total.id = `bet-total-${value}`;
                            if (bets[value]?.total) total.textContent = `${bets[value].total}`;
                            cell.append(span, plus, total);
                        }
                        row.appendChild(cell);
                    }
                    tbody.appendChild(row);
                }
                highlightCellsByLimit();
            }
            // Event Listeners
            // Amount button selection
            amountButtons.forEach(btn => {
                btn.onclick = () => {
                    amountButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    customAmountInput.value = '';
                };
            });
            customAmountInput.addEventListener('input', () => {
                amountButtons.forEach(b => b.classList.remove('selected'));
            });
            closeModalBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
            // Tab switching
            placeTab.onclick = switchToPlaceTab;
            historyTab.onclick = switchToHistoryTab;
            // Confirm Bet
            confirmBtn.onclick = async () => {
                let amount = 0;
                const selected = document.querySelector('.amount-button.selected');
                if (selected) {
                    amount = parseFloat(selected.dataset.amount);
                } else {
                    amount = parseFloat(customAmountInput.value);
                }
                if (!amount || amount <= 0) {
                    return showToast('Invalid Amount', 'Please select or enter an amount', 'warning');
                }
                if (!selected) {
                    if (amount < 1) return showToast('Amount Too Low', 'Minimum is 1', 'warning');
                    if (amount > 5000) return showToast('Amount Too High', 'Maximum is 5,000', 'warning');
                }
                if (currentBetType === 'SINGLE') {
                    const result = await placeSingleBet(currentNumber, amount);
                    if (result.success) {
                        showToast('Success!', `Bet of ${amount} placed on ${currentNumber}`, 'success');
                        closeModal();
                        await updateTotalAmount();
                        await refreshAllBetTotals();
                    } else {
                        showToast('Error', result.error || 'Failed to place bet', 'error');
                    }
                } else if (currentBetType === 'JODI') {
                    const columns = getSelectedColumns('jodiColumnCheckbox');
                    if (columns.length === 0) {
                        return showToast('No Columns Selected', 'Please select at least one column', 'warning');
                    }
                    const jodiType = parseInt(document.getElementById('jodiType').value);
                    const result = await placeBulkBet('JODI', amount, columns, jodiType);
                    if (result.success) {
                        const columnText = columns.length > 1
                            ? `${columns.length} columns (${columns.join(', ')})`
                            : `Column ${columns[0]}`;
                        showToast('Success!', `Jodi Vagar ${jodiType} bet placed on ${columnText}: ${result.total_bets} numbers`, 'success');
                        closeModal();
                        renderPage(1);
                        await getLastBulkAction();
                        await updateTotalAmount();
                        await refreshAllBetTotals();
                    } else {
                        showToast('Error', result.error || 'Failed to place Jodi bet', 'error');
                    }
                } else if (currentBetType === 'EKI_BEKI') {
                    const ekiBekiType = document.getElementById('ekiBekiType').value;
                    const result = await placeBulkBet(ekiBekiType, amount);
                    if (result.success) {
                        showToast('Success!', `${ekiBekiType} bet placed on ${result.total_bets} numbers`, 'success');
                        closeModal();
                        renderPage(1);
                        await getLastBulkAction();
                        await updateTotalAmount();
                    } else {
                        showToast('Error', result.error || 'Failed to place bet', 'error');
                    }
                } else if (currentBetType === 'ABR_CUT') {
                    const columns = getSelectedColumns('abrCutColumnCheckbox');
                    if (columns.length === 0) {
                        return showToast('No Columns Selected', 'Please select at least one column', 'warning');
                    }
                    const result = await placeBulkBet('ABR_CUT', amount, columns);
                    if (result.success) {
                        const columnText = columns.length > 1
                            ? `${columns.length} columns (${columns.join(', ')})`
                            : `Column ${columns[0]}`;
                        showToast('Success!', `ABR Cut bet placed on ${columnText}: ${result.total_bets} numbers`, 'success');
                        closeModal();
                        renderPage(1);
                        await getLastBulkAction();
                        await updateTotalAmount();
                        await refreshAllBetTotals();
                    } else {
                        showToast('Error', result.error || 'Failed to place ABR Cut bet', 'error');
                    }
                } else if (currentBetType === 'JODI_PANEL') {
                    const columns = getSelectedColumns('jodiPanelColumnCheckbox');
                    if (columns.length === 0) {
                        return showToast('No Columns Selected', 'Please select at least one column', 'warning');
                    }
                    const panelType = parseInt(document.getElementById('jodiPanelType').value);
                    const result = await placeBulkBet('JODI_PANEL', amount, columns, null, panelType);
                    if (result.success) {
                        const columnText = columns.length > 1
                            ? `${columns.length} columns (${columns.join(', ')})`
                            : `Column ${columns[0]}`;
                        showToast('Success!', `Jodi Panel ${panelType} bet placed on ${columnText}: ${result.total_bets} numbers`, 'success');
                        closeModal();
                        renderPage(1);
                        await getLastBulkAction();
                        await updateTotalAmount();
                        await refreshAllBetTotals();
                    } else {
                        showToast('Error', result.error || 'Failed to place Jodi Panel bet', 'error');
                    }
                } else if (['SP', 'DP'].includes(currentBetType)) {
                    let columns = null;
                    // For SP/DP, columns are optional
                    columns = getSelectedColumns('betColumnCheckbox');
                    columns = columns.length > 0 ? columns : null;
                    const result = await placeBulkBet(currentBetType, amount, columns);
                    if (result.success) {
                        let message = `${successCount} bets placed successfully`;
                        if (columns && columns.length > 0) {
                            const columnText = columns.length > 1
                                ? `${columns.length} columns (${columns.join(', ')})`
                                : `Column ${columns[0]}`;
                            message = `${currentBetType} bet placed on ${columnText}: ${result.total_bets} numbers`;
                        }
                        showToast('Success!', message, 'success');
                        closeModal();
                        renderPage(currentBetType === 'SP' ? 1 : 2);
                        await getLastBulkAction();
                        await updateTotalAmount();
                    } else {
                        showToast('Error', result.error || 'Failed to place bets', 'error');
                    }
                } else if (currentBetType === 'MOTAR') {
                    const motarInput = document.getElementById('motarNumberInput').value;
                    const isMultipleMode = document.getElementById('multipleMotarCheckbox').checked;
                    
                    if (isMultipleMode) {
                        // Multiple motar mode
                        const motars = motarInput.split(',').filter(m => m.trim() !== '');
                        const validMotars = motars.filter(m => m.length >= 4 && m.length <= 10);
                        
                        if (validMotars.length === 0) {
                            return showToast('Invalid Input', 'Please enter at least one valid 4-10 digit number', 'warning');
                        }
                        
                        try {
                            let totalBetsPlaced = 0;
                            let allBetsData = [];
                            lastMotarBets = []; // Clear previous tracking
                            
                            // Place bets for each motar
                            for (const motar of validMotars) {
                                const res = await fetch(API.PLACE_MOTAR, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCSRFToken()
                                    },
                                    body: JSON.stringify({
                                        digits: motar,
                                        amount: amount,
                                        bazar: currentBazar,
                                        date: currentDate
                                    })
                                });
                                const data = await res.json();
                                if (data.success) {
                                    totalBetsPlaced += data.total_bets;
                                    allBetsData.push(data);
                                    
                                    data.bets.forEach(bet => {
                                        const num = bet.number;
                                        if (!bets[num]) bets[num] = { total: 0, history: [] };
                                        bets[num].total += parseFloat(bet.amount);
                                        bets[num].history.push({
                                            id: bet.bet_id,
                                            amount: parseFloat(bet.amount),
                                            bet_type: 'MOTAR'
                                        });
                                        updateBetTotal(num);
                                        // Track for undo
                                        lastMotarBets.push({
                                            bet_id: bet.bet_id,
                                            number: bet.number,
                                            amount: parseFloat(bet.amount)
                                        });
                                    });
                                }
                            }
                            
                            if (totalBetsPlaced > 0) {
                                lastBulkAction = {
                                    id: allBetsData[allBetsData.length - 1].bulk_action_id,
                                    type: 'MOTAR',
                                    total_bets: totalBetsPlaced
                                };
                                showToast('Success!', `Multiple Motar: ${totalBetsPlaced} bets placed from ${validMotars.length} motars`, 'success');
                                closeModal();
                                renderPage(1);
                                await updateTotalAmount();
                                await refreshAllBetTotals();
                                updateUndoButton();
                            } else {
                                showToast('Error', 'Failed to place any Motar bets', 'error');
                            }
                        } catch (err) {
                            console.error('Error placing Multiple Motar bets:', err);
                            showToast('Error', 'Failed to place Motar bets', 'error');
                        }
                    } else {
                        // Single motar mode - original behavior
                        if (!motarInput || motarInput.length < 4 || motarInput.length > 10) {
                            return showToast('Invalid Input', 'Please enter a 4-10 digit number', 'warning');
                        }
                        try {
                            // Call Django API to place all Motar bets in one transaction
                            const res = await fetch(API.PLACE_MOTAR, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({
                                    digits: motarInput,
                                    amount: amount,
                                    bazar: currentBazar,
                                    date: currentDate
                                })
                            });
                            const data = await res.json();
                            if (data.success) {
                                lastMotarBets = []; // Clear previous tracking
                                data.bets.forEach(bet => {
                                    const num = bet.number;
                                    if (!bets[num]) bets[num] = { total: 0, history: [] };
                                    bets[num].total += parseFloat(bet.amount);
                                    bets[num].history.push({
                                        id: bet.bet_id,
                                        amount: parseFloat(bet.amount),
                                        bet_type: 'MOTAR'
                                    });
                                    updateBetTotal(num);
                                    // Track for undo
                                    lastMotarBets.push({
                                        bet_id: bet.bet_id,
                                        number: bet.number,
                                        amount: parseFloat(bet.amount)
                                    });
                                });
                                lastBulkAction = {
                                    id: data.bulk_action_id,
                                    type: 'MOTAR',
                                    total_bets: data.total_bets
                                };
                                showToast('Success!', `Motar: ${data.total_bets} bets placed from ${motarInput}`, 'success');
                                closeModal();
                                renderPage(1);
                                await updateTotalAmount();
                                await refreshAllBetTotals();
                                updateUndoButton();
                            } else {
                                showToast('Error', data.error || 'Failed to place Motar bets', 'error');
                            }
                        } catch (err) {
                            console.error('Error placing Motar bets:', err);
                            showToast('Error', 'Failed to place Motar bets', 'error');
                        }
                    }
                } else if (currentBetType === 'COMMAN_PANA') {
                    const digitInput = document.getElementById('commanPanaDigitInput').value;
                    const is36Checked = document.getElementById('commanPana36Checkbox').checked;
                    const is56Checked = document.getElementById('commanPana56Checkbox').checked;
                    if (!digitInput || digitInput.length !== 1 || !/^[0-9]$/.test(digitInput)) {
                        return showToast('Invalid Input', 'Please enter a single digit (0-9)', 'warning');
                    }
                    if (!is36Checked && !is56Checked) {
                        return showToast('Select Type', 'Please select Common Pana 36 or 56', 'warning');
                    }
                    const betType = is56Checked ? '56' : '36';
                    const betTypeName = is56Checked ? 'COMMAN_PANA_56' : 'COMMAN_PANA_36';
                    const betLabel = is56Checked ? 'Common Pana 56' : 'Common Pana 36';
                    try {
                        // Call Django API to place all Common Pana bets in one transaction
                        const res = await fetch(API.PLACE_COMMAN_PANA, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                digit: parseInt(digitInput),
                                amount: amount,
                                type: betType,
                                bazar: currentBazar,
                                date: currentDate
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            lastCommanPanaBets = []; // Clear previous tracking
                            data.bets.forEach(bet => {
                                const num = bet.number;
                                if (!bets[num]) bets[num] = { total: 0, history: [] };
                                bets[num].total += parseFloat(bet.amount);
                                bets[num].history.push({
                                    id: bet.bet_id,
                                    amount: parseFloat(bet.amount),
                                    bet_type: betTypeName
                                });
                                updateBetTotal(num);
                                // Track for undo
                                lastCommanPanaBets.push({
                                    bet_id: bet.bet_id,
                                    number: bet.number,
                                    amount: parseFloat(bet.amount)
                                });
                            });
                            lastBulkAction = {
                                id: data.bulk_action_id,
                                type: betTypeName,
                                total_bets: data.total_bets
                            };
                            showToast('Success!', `${betLabel}: ${data.total_bets} bets placed for digit ${digitInput}`, 'success');
                            closeModal();
                            renderPage(1);
                            await updateTotalAmount();
                            await refreshAllBetTotals();
                            updateUndoButton();
                        } else {
                            showToast('Error', data.error || 'Failed to place Common Pana bets', 'error');
                        }
                    } catch (err) {
                        console.error('Error placing Common Pana bets:', err);
                        showToast('Error', 'Failed to place Common Pana bets', 'error');
                    }
                } else if (currentBetType === 'SET_PANA') {
                    const numberInput = document.getElementById('setPanaNumberInput').value;
                    const isMultipleMode = document.getElementById('multipleSetPanaCheckbox').checked;

                    // Family definitions for validation
                    const familyPanaNumbers = {
                        'G1': [678, 123, 137, 268, 236, 178, 128, 367],
                        'G2': [345, 890, 390, 458, 480, 359, 589, 340],
                        'G3': [120, 567, 157, 260, 256, 170, 670, 125],
                        'G4': [789, 234, 239, 478, 248, 379, 347, 289],
                        'G5': [456, 190, 140, 569, 159, 460, 690, 145],
                        'G6': [245, 290, 470, 579, 790, 457, 259, 240],
                        'G7': [129, 147, 246, 679, 467, 269, 179, 124],
                        'G8': [139, 148, 346, 689, 468, 369, 189, 134],
                        'G9': [130, 158, 356, 680, 568, 360, 180, 135],
                        'G10': [230, 258, 357, 780, 578, 370, 280, 235],
                        'G11': [146, 119, 669, 169, 466, 114],
                        'G12': [138, 336, 688, 368, 188, 133],
                        'G13': [238, 337, 788, 378, 288, 233],
                        'G14': [149, 446, 699, 469, 199, 144],
                        'G15': [168, 113, 366, 136, 668, 118],
                        'G16': [380, 335, 588, 358, 880, 330],
                        'G17': [156, 110, 660, 160, 566, 115],
                        'G18': [247, 229, 779, 279, 477, 224],
                        'G19': [167, 112, 266, 126, 667, 117],
                        'G20': [249, 447, 799, 479, 299, 244],
                        'G21': [489, 344, 399, 349, 899, 448],
                        'G22': [570, 255, 200, 250, 700, 557],
                        'G23': [490, 445, 599, 459, 990, 440],
                        'G24': [257, 220, 770, 270, 577, 225],
                        'G25': [267, 122, 177, 127, 677, 226],
                        'G26': [560, 100, 155, 150, 556, 600],
                        'G27': [237, 228, 778, 278, 377, 223],
                        'G28': [580, 300, 355, 350, 558, 800],
                        'G29': [590, 400, 455, 450, 559, 900],
                        'G30': [348, 339, 889, 389, 488, 334],
                        'G31': [227, 777, 277, 222],
                        'G32': [499, 444, 449, 999],
                        'G33': [166, 111, 116, 666],
                        'G34': [338, 888, 388, 333],
                        'G35': [500, 555, 550, 0]
                    };

                    // Helper function to find family for a number
                    function findFamily(numInt) {
                        for (const [family, numbers] of Object.entries(familyPanaNumbers)) {
                            if (numbers.includes(numInt)) {
                                return family;
                            }
                        }
                        return null;
                    }

                    if (isMultipleMode) {
                        // Multiple set pana mode
                        const numbers = numberInput.split(',').map(n => n.trim()).filter(n => n !== '');
                        const validNumbers = numbers.filter(n => n.length === 3 && /^[0-9]{3}$/.test(n) && findFamily(parseInt(n)));

                        if (validNumbers.length === 0) {
                            return showToast('Invalid Input', 'Please enter at least one valid 3-digit number from a family group', 'warning');
                        }

                        try {
                            let totalBetsPlaced = 0;
                            let allBetsData = [];
                            let processedFamilies = [];

                            // Place bets for each number (each number places bets for its family)
                            for (const numStr of validNumbers) {
                                const numInt = parseInt(numStr);
                                const family = findFamily(numInt);

                                const res = await fetch(API.PLACE_SET_PANA, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCSRFToken()
                                    },
                                    body: JSON.stringify({
                                        number: numInt,
                                        amount: amount,
                                        bazar: currentBazar,
                                        date: currentDate
                                    })
                                });
                                const data = await res.json();
                                if (data.success) {
                                    totalBetsPlaced += data.total_bets;
                                    allBetsData.push(data);
                                    processedFamilies.push(family);

                                    data.bets.forEach(bet => {
                                        const num = bet.number;
                                        if (!bets[num]) bets[num] = { total: 0, history: [] };
                                        bets[num].total += parseFloat(bet.amount);
                                        bets[num].history.push({
                                            id: bet.bet_id,
                                            amount: parseFloat(bet.amount),
                                            bet_type: 'SET_PANA'
                                        });
                                        updateBetTotal(num);
                                    });
                                }
                            }

                            if (totalBetsPlaced > 0) {
                                lastBulkAction = {
                                    id: allBetsData[allBetsData.length - 1].bulk_action_id,
                                    type: 'SET_PANA',
                                    total_bets: totalBetsPlaced
                                };
                                showToast('Success!', `Multiple Set Pana: ${totalBetsPlaced} bets placed from ${processedFamilies.length} families (${processedFamilies.join(', ')})`, 'success');
                                closeModal();
                                renderPage(1);
                                await getLastBulkAction();
                                await updateTotalAmount();
                                await refreshAllBetTotals();
                                updateUndoButton();
                            } else {
                                showToast('Error', 'Failed to place any Set Pana bets', 'error');
                            }
                        } catch (err) {
                            console.error('Error placing Multiple Set Pana bets:', err);
                            showToast('Error', 'Failed to place Set Pana bets', 'error');
                        }
                    } else {
                        // Single mode - original behavior
                        if (!numberInput || numberInput.length !== 3 || !/^[0-9]{3}$/.test(numberInput)) {
                            return showToast('Invalid Input', 'Please enter exactly 3 digits', 'warning');
                        }
                        // Check if family info is displayed (means number is valid)
                        const familyInfoDiv = document.getElementById('setPanaFamilyInfo');
                        if (familyInfoDiv.classList.contains('hidden')) {
                            return showToast('Invalid Number', 'Number not found in any family group', 'warning');
                        }
                        const familyName = document.getElementById('setPanaFamilyName').textContent;
                        try {
                            // Call Django API to place all Set Pana bets in one transaction
                            const res = await fetch(API.PLACE_SET_PANA, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({
                                    number: parseInt(numberInput),
                                    amount: amount,
                                    bazar: currentBazar,
                                    date: currentDate
                                })
                            });
                            const data = await res.json();
                            if (data.success) {
                                data.bets.forEach(bet => {
                                    const num = bet.number;
                                    if (!bets[num]) bets[num] = { total: 0, history: [] };
                                    bets[num].total += parseFloat(bet.amount);
                                    bets[num].history.push({
                                        id: bet.bet_id,
                                        amount: parseFloat(bet.amount),
                                        bet_type: 'SET_PANA'
                                    });
                                    updateBetTotal(num);
                                });
                                lastBulkAction = {
                                    id: data.bulk_action_id,
                                    type: 'SET_PANA',
                                    total_bets: data.total_bets
                                };
                                showToast('Success!', `Set Pana: ${data.total_bets} bets placed for family ${familyName}`, 'success');
                                closeModal();
                                renderPage(1);
                                await getLastBulkAction();
                                await updateTotalAmount();
                                await refreshAllBetTotals();
                                updateUndoButton();
                            } else {
                                showToast('Error', data.error || 'Failed to place Set Pana bets', 'error');
                            }
                        } catch (err) {
                            console.error('Error placing Set Pana bets:', err);
                            showToast('Error', 'Failed to place Set Pana bets', 'error');
                        }
                    }
                } else if (currentBetType === 'GROUP') {
                    const digitsInput = document.getElementById('groupBetDigitsInput').value;
                    const isMultipleMode = document.getElementById('multipleGroupCheckbox').checked;

                    if (isMultipleMode) {
                        // Multiple group mode
                        const groups = digitsInput.split(',').map(g => g.trim()).filter(g => g !== '');
                        const validGroups = groups.filter(g => g.length === 2 && /^[0-9]{2}$/.test(g));

                        if (validGroups.length === 0) {
                            return showToast('Invalid Input', 'Please enter at least one valid 2-digit group', 'warning');
                        }

                        try {
                            let totalBetsPlaced = 0;
                            let allBetsData = [];
                            let processedGroups = [];

                            // Place bets for each group
                            for (const group of validGroups) {
                                const d1 = parseInt(group[0]);
                                const d2 = parseInt(group[1]);

                                const res = await fetch(API.PLACE_GROUP, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCSRFToken()
                                    },
                                    body: JSON.stringify({
                                        digit1: d1,
                                        digit2: d2,
                                        amount: amount,
                                        bazar: currentBazar,
                                        date: currentDate
                                    })
                                });
                                const data = await res.json();
                                if (data.success) {
                                    totalBetsPlaced += data.total_bets;
                                    allBetsData.push(data);
                                    processedGroups.push(group);

                                    data.bets.forEach(bet => {
                                        const num = bet.number;
                                        if (!bets[num]) bets[num] = { total: 0, history: [] };
                                        bets[num].total += parseFloat(bet.amount);
                                        bets[num].history.push({
                                            id: bet.bet_id,
                                            amount: parseFloat(bet.amount),
                                            bet_type: 'GROUP'
                                        });
                                        updateBetTotal(num);
                                    });
                                }
                            }

                            if (totalBetsPlaced > 0) {
                                lastBulkAction = {
                                    id: allBetsData[allBetsData.length - 1].bulk_action_id,
                                    type: 'GROUP',
                                    total_bets: totalBetsPlaced
                                };
                                showToast('Success!', `Multiple Group: ${totalBetsPlaced} bets placed from ${processedGroups.length} groups (${processedGroups.join(', ')})`, 'success');
                                closeModal();
                                renderPage(1);
                                await getLastBulkAction();
                                await updateTotalAmount();
                                await refreshAllBetTotals();
                                updateUndoButton();
                            } else {
                                showToast('Error', 'Failed to place any Group bets', 'error');
                            }
                        } catch (err) {
                            console.error('Error placing Multiple Group bets:', err);
                            showToast('Error', 'Failed to place Group bets', 'error');
                        }
                    } else {
                        // Single group mode - original behavior
                        if (digitsInput.length !== 2) {
                            return showToast('Invalid Input', 'Please enter exactly 2 digits', 'warning');
                        }

                        const d1 = parseInt(digitsInput[0]);
                        const d2 = parseInt(digitsInput[1]);

                        if (isNaN(d1) || isNaN(d2) || d1 < 0 || d1 > 9 || d2 < 0 || d2 > 9) {
                            return showToast('Invalid Input', 'Please enter valid digits (0-9)', 'warning');
                        }

                        try {
                            // Call Django API to place all Group bets in one transaction
                            const res = await fetch(API.PLACE_GROUP, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({
                                    digit1: d1,
                                    digit2: d2,
                                    amount: amount,
                                    bazar: currentBazar,
                                    date: currentDate
                                })
                            });

                            const data = await res.json();

                            if (data.success) {
                                // Update local bets data
                                data.bets.forEach(bet => {
                                    const num = bet.number;
                                    if (!bets[num]) bets[num] = { total: 0, history: [] };
                                    bets[num].total += parseFloat(bet.amount);
                                    bets[num].history.push({
                                        id: bet.bet_id,
                                        amount: parseFloat(bet.amount),
                                        bet_type: 'GROUP'
                                    });
                                    updateBetTotal(num);
                                });

                                lastBulkAction = {
                                    id: data.bulk_action_id,
                                    type: 'GROUP',
                                    total_bets: data.total_bets
                                };

                                showToast('Success!', `Group Bet: ${data.total_bets} bets placed for digits ${d1} and ${d2}`, 'success');
                                closeModal();
                                renderPage(1);
                                await getLastBulkAction();
                                await updateTotalAmount();
                                await refreshAllBetTotals();
                                updateUndoButton();
                            } else {
                                showToast('Error', data.error || 'Failed to place Group bets', 'error');
                            }
                        } catch (err) {
                            console.error('Error placing Group bets:', err);
                            showToast('Error', 'Failed to place Group bets', 'error');
                        }
                    }
                } else if (currentBetType === 'COLUMN') {
                    const columns = getSelectedColumns('columnBetCheckbox');
                    if (columns.length === 0) {
                        return showToast('No Columns Selected', 'Please select at least one column', 'warning');
                    }
                    try {
                        let successCount = 0;
                        let failCount = 0;
                        for (const column of columns) {
                            const res = await fetch(API.PLACE_COLUMN_BET, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({
                                    column: column,
                                    amount: amount,
                                    bazar: currentBazar,
                                    date: currentDate
                                })
                            });
                            const data = await res.json();
                            if (data.success) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        }
                        if (successCount > 0) {
                            const columnText = columns.length > 1 ? `${columns.length} columns (${columns.join(', ')})` : `Column ${columns[0]}`;
                            showToast('Success!', `Bet of ${amount} placed on ${columnText}`, 'success');
                            closeModal();
                            await updateTotalAmount();
                            await refreshColumnTotals();
                        }
                        if (failCount > 0) {
                            showToast('Warning', `${failCount} column bet(s) failed`, 'warning');
                        }
                    } catch (err) {
                        console.error('Error placing column bet:', err);
                        showToast('Error', 'Failed to place column bet', 'error');
                    }
                }
            };
            // Undo button
            undoBtn.onclick = undoBulkAction;
            // Eki/Beki/Dadar type change listener to update undo button
            document.getElementById('ekiBekiType').addEventListener('change', function () {
                updateUndoButton();
            });
            // "Select All Columns" checkbox event listener
            document.getElementById('selectAllColumnsCheckbox').addEventListener('change', function () {
                let checkboxClass;
                // Determine which checkboxes to select based on current bet type
                if (currentBetType === 'ABR_CUT') {
                    checkboxClass = 'abrCutColumnCheckbox';
                } else if (currentBetType === 'JODI') {
                    checkboxClass = 'jodiColumnCheckbox';
                } else if (currentBetType === 'JODI_PANEL') {
                    checkboxClass = 'jodiPanelColumnCheckbox';
                } else {
                    return;
                }
                if (this.checked) {
                    // Check all checkboxes
                    document.querySelectorAll(`.${checkboxClass}`).forEach(cb => {
                        cb.checked = true;
                    });
                    showToast('All Columns Selected', 'All 10 columns have been selected', 'success');
                } else {
                    // Uncheck all checkboxes
                    document.querySelectorAll(`.${checkboxClass}`).forEach(cb => {
                        cb.checked = false;
                    });
                    showToast('Columns Cleared', 'All columns have been deselected', 'success');
                }
            });
            // Page navigation
            document.getElementById('page-1-btn').onclick = () => renderPage(1);
            document.getElementById('page-2-btn').onclick = () => renderPage(2);
            // Load saved limits from localStorage
            const savedSpLimit = localStorage.getItem('spAmountLimit');
            const savedDpLimit = localStorage.getItem('dpAmountLimit');
            if (savedSpLimit) {
                spAmountLimit = parseFloat(savedSpLimit);
                document.getElementById('sp-limit-input').value = savedSpLimit;
            }
            if (savedDpLimit) {
                dpAmountLimit = parseFloat(savedDpLimit);
                document.getElementById('dp-limit-input').value = savedDpLimit;
            }
            // SP Limit Input
            document.getElementById('sp-limit-input').addEventListener('input', function (e) {
                const value = e.target.value;
                if (value === '' || value === '0') {
                    spAmountLimit = null;
                    localStorage.removeItem('spAmountLimit');
                    highlightCellsByLimit();
                    return;
                }
                const numLimit = parseFloat(value);
                if (!isNaN(numLimit) && numLimit > 0) {
                    spAmountLimit = numLimit;
                    localStorage.setItem('spAmountLimit', numLimit);
                    if (currentPage === 1) {
                        highlightCellsByLimit();
                    }
                }
            });
            // DP Limit Input
            document.getElementById('dp-limit-input').addEventListener('input', function (e) {
                const value = e.target.value;
                if (value === '' || value === '0') {
                    dpAmountLimit = null;
                    localStorage.removeItem('dpAmountLimit');
                    highlightCellsByLimit();
                    return;
                }
                const numLimit = parseFloat(value);
                if (!isNaN(numLimit) && numLimit > 0) {
                    dpAmountLimit = numLimit;
                    localStorage.setItem('dpAmountLimit', numLimit);
                    if (currentPage === 2) {
                        highlightCellsByLimit();
                    }
                }
            });
            // Function to highlight cells based on amount limit
            function highlightCellsByLimit() {
                // Remove all existing highlights first
                document.querySelectorAll('.spreadsheet-cell').forEach(cell => {
                    cell.classList.remove('highlight-limit');
                });
                const limit = currentPage === 1 ? spAmountLimit : dpAmountLimit;
                if (limit === null) return;
                document.querySelectorAll('span[id^="bet-total-"]').forEach(betTotalSpan => {
                    const amount = parseFloat(betTotalSpan.textContent) || 0;
                    if (amount > 0 && amount >= limit) {
                        const cell = betTotalSpan.closest('.spreadsheet-cell');
                        if (cell) {
                            cell.classList.add('highlight-limit');
                        }
                    }
                });
            }
            // Bet action buttons
            document.getElementById('all-sp-btn').onclick = () => {
                openModal('SP', null, 'Place Bet on ALL SP (120 numbers)');
            };
            document.getElementById('all-dp-btn').onclick = () => {
                openModal('DP', null, 'Place Bet on ALL DP (100 numbers)');
            };
            document.getElementById('jodi-btn').onclick = () => {
                openModal('JODI', null, 'Jodi Vagar');
            };
            document.getElementById('eki-beki-btn').onclick = () => {
                openModal('EKI_BEKI', null, 'Eki/Beki/Dadar');
            };
            document.getElementById('abr-cut-btn').onclick = () => {
                openModal('ABR_CUT', null, 'ABR Cut');
            };
            document.getElementById('jodi-panel-btn').onclick = () => {
                openModal('JODI_PANEL', null, 'Jodi Panel');
            };
            document.getElementById('motar-btn').onclick = () => {
                openModal('MOTAR', null, 'Motar');
            };
            document.getElementById('comman-pana-btn').onclick = () => {
                openModal('COMMAN_PANA', null, 'Common Bet');
            };
            document.getElementById('set-pana-btn').onclick = () => {
                openModal('SET_PANA', null, 'Set Pana');
            };
            document.getElementById('column-bet-btn').onclick = () => {
                openModal('COLUMN', null, 'Place Bet on Column Number');
            };
            document.getElementById('group-bet-btn').onclick = () => {
                openModal('GROUP', null, 'Group Bet - Place on Numbers Containing Two Digits');
            };
            
            // Multiple Motar checkbox handler
            document.getElementById('multipleMotarCheckbox').addEventListener('change', function() {
                const motarInput = document.getElementById('motarNumberInput');
                const inputLabel = document.getElementById('motarInputLabel');
                const inputHint = document.getElementById('motarInputHint');
                
                if (this.checked) {
                    motarInput.placeholder = 'e.g. 23456,56789,12345';
                    motarInput.maxLength = 100; // Allow longer input for multiple motars
                    inputLabel.textContent = 'Enter Multiple Numbers (comma separated)';
                    inputHint.textContent = 'Enter multiple 4-10 digit numbers separated by commas. Only digits and commas allowed.';
                } else {
                    motarInput.placeholder = 'e.g. 4789';
                    motarInput.maxLength = 10;
                    inputLabel.textContent = 'Enter Number (4-10 digits)';
                    inputHint.textContent = 'Enter 4-10 digit number. Only digits 0-9 allowed.';
                }
                // Clear input and preview when toggling
                motarInput.value = '';
                document.getElementById('motarGeneratedNumbers').classList.add('hidden');
            });
            
            // Motar number input handler - call Django API for preview
            document.getElementById('motarNumberInput').addEventListener('input', async function (e) {
                const isMultipleMode = document.getElementById('multipleMotarCheckbox').checked;
                const generatedDiv = document.getElementById('motarGeneratedNumbers');
                const displayDiv = document.getElementById('motarNumbersDisplay');
                const countSpan = document.getElementById('motarNumbersCount');
                
                if (isMultipleMode) {
                    // Multiple motar mode - allow digits and commas
                    let value = e.target.value.replace(/[^0-9,]/g, '');
                    e.target.value = value;
                    
                    // Split by comma and validate each motar
                    const motars = value.split(',').filter(m => m.trim() !== '');
                    const validMotars = motars.filter(m => m.length >= 4 && m.length <= 10);
                    
                    if (validMotars.length > 0) {
                        try {
                            // Call Django API for each motar and combine results
                            let allNumbers = [];
                            let motarLabels = [];
                            
                            for (const motar of validMotars) {
                                const res = await fetch(API.GENERATE_MOTAR, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCSRFToken()
                                    },
                                    body: JSON.stringify({ digits: motar })
                                });
                                const data = await res.json();
                                if (data.success) {
                                    motarLabels.push({ motar: motar, count: data.numbers.length });
                                    data.numbers.forEach(num => {
                                        if (!allNumbers.includes(num)) {
                                            allNumbers.push(num);
                                        }
                                    });
                                }
                            }
                            
                            // Display generated numbers with motar breakdown
                            let html = '';
                            if (motarLabels.length > 1) {
                                html += '<div class="text-xs text-gray-600 mb-2">';
                                html += motarLabels.map(m => `<span class="inline-block mr-2 mb-1 px-2 py-0.5 bg-orange-200 rounded">${m.motar}: ${m.count} nums</span>`).join('');
                                html += '</div>';
                            }
                            html += '<div class="flex flex-wrap gap-2">';
                            html += allNumbers.sort().map(num =>
                                `<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-sm font-mono">${num}</span>`
                            ).join('');
                            html += '</div>';
                            
                            displayDiv.innerHTML = html;
                            countSpan.textContent = allNumbers.length + ' (unique)';
                            generatedDiv.classList.remove('hidden');
                        } catch (err) {
                            console.error('Error generating Motar numbers:', err);
                            generatedDiv.classList.add('hidden');
                        }
                    } else {
                        generatedDiv.classList.add('hidden');
                    }
                } else {
                    // Single motar mode - original behavior
                    let value = e.target.value.replace(/[^0-9]/g, ''); // Only allow digits
                    e.target.value = value;
                    
                    if (value.length >= 4 && value.length <= 10) {
                        try {
                            // Call Django API to generate numbers
                            const res = await fetch(API.GENERATE_MOTAR, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({ digits: value })
                            });
                            const data = await res.json();
                            if (data.success) {
                                const numbers = data.numbers;
                                // Display generated numbers
                                displayDiv.innerHTML = numbers.map(num =>
                                    `<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-sm font-mono">${num}</span>`
                                ).join('');
                                countSpan.textContent = numbers.length;
                                generatedDiv.classList.remove('hidden');
                            } else {
                                generatedDiv.classList.add('hidden');
                            }
                        } catch (err) {
                            console.error('Error generating Motar numbers:', err);
                            generatedDiv.classList.add('hidden');
                        }
                    } else {
                        generatedDiv.classList.add('hidden');
                    }
                }
            });
            // Comman Pana digit input handler - call Django API for preview
            document.getElementById('commanPanaDigitInput').addEventListener('input', async function (e) {
                let value = e.target.value.replace(/[^0-9]/g, ''); // Only allow digits
                if (value.length > 1) value = value.slice(0, 1); // Limit to 1 digit
                e.target.value = value;
                const generatedDiv = document.getElementById('commanPanaGeneratedNumbers');
                const displayDiv = document.getElementById('commanPanaNumbersDisplay');
                const countSpan = document.getElementById('commanPanaNumbersCount');
                if (value.length === 1) {
                    // Check which type is selected
                    const is36Checked = document.getElementById('commanPana36Checkbox').checked;
                    const is56Checked = document.getElementById('commanPana56Checkbox').checked;
                    if (!is36Checked && !is56Checked) {
                        showToast('Select Type', 'Please select Common Pana 36 or 56', 'warning');
                        return;
                    }
                    const betType = is56Checked ? '56' : '36';
                    try {
                        // Call Django API to find numbers
                        const res = await fetch(API.FIND_COMMAN_PANA, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                digit: parseInt(value),
                                type: betType
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            const numbers = data.numbers;
                            // Display found numbers
                            displayDiv.innerHTML = numbers.map(num =>
                                `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-mono">${num}</span>`
                            ).join('');
                            countSpan.textContent = numbers.length;
                            generatedDiv.classList.remove('hidden');
                        } else {
                            generatedDiv.classList.add('hidden');
                        }
                    } catch (err) {
                        console.error('Error finding Common Pana numbers:', err);
                        generatedDiv.classList.add('hidden');
                    }
                } else {
                    generatedDiv.classList.add('hidden');
                }
            });
            // Add checkbox change listeners for Common Pana types
            document.getElementById('commanPana36Checkbox').addEventListener('change', function () {
                if (this.checked) {
                    document.getElementById('commanPana56Checkbox').checked = false;
                }
                // Trigger digit input to refresh numbers
                const digitInput = document.getElementById('commanPanaDigitInput');
                if (digitInput.value) {
                    digitInput.dispatchEvent(new Event('input'));
                }
            });
            document.getElementById('commanPana56Checkbox').addEventListener('change', function () {
                if (this.checked) {
                    document.getElementById('commanPana36Checkbox').checked = false;
                }
                // Trigger digit input to refresh numbers
                const digitInput = document.getElementById('commanPanaDigitInput');
                if (digitInput.value) {
                    digitInput.dispatchEvent(new Event('input'));
                }
            });

            // Multiple Set Pana checkbox handler
            document.getElementById('multipleSetPanaCheckbox').addEventListener('change', function() {
                const setPanaInput = document.getElementById('setPanaNumberInput');
                const inputLabel = document.getElementById('setPanaInputLabel');
                const inputHint = document.getElementById('setPanaInputHint');
                const familyInfoDiv = document.getElementById('setPanaFamilyInfo');
                
                if (this.checked) {
                    setPanaInput.placeholder = 'e.g. 115,678,234';
                    setPanaInput.maxLength = 100; // Allow longer input for multiple numbers
                    inputLabel.textContent = 'Enter Multiple Numbers (comma separated)';
                    inputHint.textContent = 'Enter multiple 3-digit numbers separated by commas. Each number will place bets on its family group.';
                } else {
                    setPanaInput.placeholder = 'e.g. 115, 156, 660';
                    setPanaInput.maxLength = 3;
                    inputLabel.textContent = 'Enter 3-Digit Number';
                    inputHint.textContent = 'Enter any 3-digit number from a family group (e.g., 115, 156, 110 are all in G17)';
                }
                // Clear input and preview when toggling
                setPanaInput.value = '';
                familyInfoDiv.classList.add('hidden');
            });

            // Set Pana number input handler - show family information
            document.getElementById('setPanaNumberInput').addEventListener('input', function (e) {
                const isMultipleMode = document.getElementById('multipleSetPanaCheckbox').checked;
                const familyInfoDiv = document.getElementById('setPanaFamilyInfo');
                const familyNameSpan = document.getElementById('setPanaFamilyName');
                const familyNumbersDiv = document.getElementById('setPanaFamilyNumbers');
                const countSpan = document.getElementById('setPanaFamilyCount');

                // Family definitions
                const familyPanaNumbers = {
                    'G1': [678, 123, 137, 268, 236, 178, 128, 367],
                    'G2': [345, 890, 390, 458, 480, 359, 589, 340],
                    'G3': [120, 567, 157, 260, 256, 170, 670, 125],
                    'G4': [789, 234, 239, 478, 248, 379, 347, 289],
                    'G5': [456, 190, 140, 569, 159, 460, 690, 145],
                    'G6': [245, 290, 470, 579, 790, 457, 259, 240],
                    'G7': [129, 147, 246, 679, 467, 269, 179, 124],
                    'G8': [139, 148, 346, 689, 468, 369, 189, 134],
                    'G9': [130, 158, 356, 680, 568, 360, 180, 135],
                    'G10': [230, 258, 357, 780, 578, 370, 280, 235],
                    'G11': [146, 119, 669, 169, 466, 114],
                    'G12': [138, 336, 688, 368, 188, 133],
                    'G13': [238, 337, 788, 378, 288, 233],
                    'G14': [149, 446, 699, 469, 199, 144],
                    'G15': [168, 113, 366, 136, 668, 118],
                    'G16': [380, 335, 588, 358, 880, 330],
                    'G17': [156, 110, 660, 160, 566, 115],
                    'G18': [247, 229, 779, 279, 477, 224],
                    'G19': [167, 112, 266, 126, 667, 117],
                    'G20': [249, 447, 799, 479, 299, 244],
                    'G21': [489, 344, 399, 349, 899, 448],
                    'G22': [570, 255, 200, 250, 700, 557],
                    'G23': [490, 445, 599, 459, 990, 440],
                    'G24': [257, 220, 770, 270, 577, 225],
                    'G25': [267, 122, 177, 127, 677, 226],
                    'G26': [560, 100, 155, 150, 556, 600],
                    'G27': [237, 228, 778, 278, 377, 223],
                    'G28': [580, 300, 355, 350, 558, 800],
                    'G29': [590, 400, 455, 450, 559, 900],
                    'G30': [348, 339, 889, 389, 488, 334],
                    'G31': [227, 777, 277, 222],
                    'G32': [499, 444, 449, 999],
                    'G33': [166, 111, 116, 666],
                    'G34': [338, 888, 388, 333],
                    'G35': [500, 555, 550, 0]
                };

                if (isMultipleMode) {
                    // Multiple mode - allow digits and commas
                    let value = e.target.value.replace(/[^0-9,]/g, '');
                    e.target.value = value;

                    const numbers = value.split(',').map(n => n.trim()).filter(n => n !== '');
                    const validNumbers = numbers.filter(n => n.length === 3 && /^[0-9]{3}$/.test(n));

                    if (validNumbers.length === 0) {
                        familyInfoDiv.classList.add('hidden');
                        return;
                    }

                    // Collect all families and their numbers
                    const allFamilies = [];
                    const allNumbers = new Set();
                    let totalCount = 0;

                    validNumbers.forEach(numStr => {
                        const numInt = parseInt(numStr);
                        for (const [family, nums] of Object.entries(familyPanaNumbers)) {
                            if (nums.includes(numInt)) {
                                if (!allFamilies.includes(family)) {
                                    allFamilies.push(family);
                                    nums.forEach(n => allNumbers.add(n));
                                    totalCount += nums.length;
                                }
                                break;
                            }
                        }
                    });

                    if (allFamilies.length > 0) {
                        familyNameSpan.textContent = allFamilies.join(', ');
                        const numbersArray = Array.from(allNumbers).sort((a, b) => a - b);
                        familyNumbersDiv.innerHTML = numbersArray.map(num =>
                            `<span class="px-2 py-1 bg-indigo-100 text-indigo-800 rounded text-sm font-mono">${String(num).padStart(3, '0')}</span>`
                        ).join('');
                        countSpan.textContent = totalCount + ' (from ' + allFamilies.length + ' families)';
                        familyInfoDiv.classList.remove('hidden');
                    } else {
                        familyInfoDiv.classList.add('hidden');
                    }
                } else {
                    // Single mode - original behavior
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = value;

                    if (value.length === 3) {
                        const numberInt = parseInt(value);
                        let foundFamily = null;
                        let foundNumbers = [];
                        for (const [family, numbers] of Object.entries(familyPanaNumbers)) {
                            if (numbers.includes(numberInt)) {
                                foundFamily = family;
                                foundNumbers = numbers;
                                break;
                            }
                        }
                        if (foundFamily) {
                            familyNameSpan.textContent = foundFamily;
                            familyNumbersDiv.innerHTML = foundNumbers.map(num =>
                                `<span class="px-2 py-1 ${num === numberInt ? 'bg-indigo-200 font-bold' : 'bg-indigo-100'} text-indigo-800 rounded text-sm font-mono">${String(num).padStart(3, '0')}</span>`
                            ).join('');
                            countSpan.textContent = foundNumbers.length;
                            familyInfoDiv.classList.remove('hidden');
                        } else {
                            familyInfoDiv.classList.add('hidden');
                            showToast('Invalid Number', `Number ${value} is not in any family group`, 'error');
                        }
                    } else {
                        familyInfoDiv.classList.add('hidden');
                    }
                }
            });
            // Add event listeners to all column checkboxes for visual feedback
            function addCheckboxListeners(checkboxClass, highlightColor) {
                document.querySelectorAll(`.${checkboxClass}`).forEach(checkbox => {
                    checkbox.addEventListener('change', function () {
                        const label = this.closest('label');
                        if (this.checked) {
                            label.classList.add(`border-${highlightColor}-500`, `bg-${highlightColor}-50`);
                            label.classList.remove('border-gray-300');
                        } else {
                            label.classList.remove(`border-${highlightColor}-500`, `bg-${highlightColor}-50`);
                            label.classList.add('border-gray-300');
                        }
                    });
                });
            }

            // Multiple Group checkbox handler
            document.getElementById('multipleGroupCheckbox').addEventListener('change', function() {
                const groupInput = document.getElementById('groupBetDigitsInput');
                const inputLabel = document.getElementById('groupInputLabel');
                const inputHint = document.getElementById('groupInputHint');
                
                if (this.checked) {
                    groupInput.placeholder = 'e.g. 23,56,89';
                    groupInput.maxLength = 100; // Allow longer input for multiple groups
                    inputLabel.textContent = 'Enter Multiple Groups (comma separated)';
                    inputHint.textContent = 'Enter multiple 2-digit groups separated by commas. Only digits and commas allowed.';
                } else {
                    groupInput.placeholder = '00';
                    groupInput.maxLength = 2;
                    inputLabel.textContent = 'Enter Two Digits (e.g., 35, 99, 07)';
                    inputHint.textContent = 'Enter exactly 2 digits (0-9). First digit and second digit will be used for matching.';
                }
                // Clear input and preview when toggling
                groupInput.value = '';
                document.getElementById('groupBetPreview').textContent = 'Enter two digits to see matching numbers';
                document.getElementById('groupBetCount').textContent = '0';
            });

            // Group Bet digit input handler - show preview of matching numbers
            function updateGroupBetPreview() {
                const digitsInput = document.getElementById('groupBetDigitsInput').value;
                const previewDiv = document.getElementById('groupBetPreview');
                const countSpan = document.getElementById('groupBetCount');
                const isMultipleMode = document.getElementById('multipleGroupCheckbox').checked;

                if (isMultipleMode) {
                    // Multiple mode - parse comma-separated groups
                    const groups = digitsInput.split(',').map(g => g.trim()).filter(g => g !== '');
                    const validGroups = groups.filter(g => g.length === 2 && /^[0-9]{2}$/.test(g));

                    if (validGroups.length === 0) {
                        previewDiv.textContent = 'Enter 2-digit groups separated by commas';
                        countSpan.textContent = '0';
                        return;
                    }

                    // Collect unique matching numbers from all groups
                    const allMatchingNumbers = new Set();
                    const groupBreakdown = [];

                    validGroups.forEach(group => {
                        const d1 = parseInt(group[0]);
                        const d2 = parseInt(group[1]);
                        const d1Str = String(d1);
                        const d2Str = String(d2);
                        let groupCount = 0;

                        validNumbers.forEach(numStr => {
                            const digits = numStr.split('');
                            if (digits.includes(d1Str) && digits.includes(d2Str)) {
                                allMatchingNumbers.add(numStr);
                                groupCount++;
                            }
                        });
                        groupBreakdown.push(`${group}: ${groupCount}`);
                    });

                    const matchingArray = Array.from(allMatchingNumbers).sort();

                    if (matchingArray.length === 0) {
                        previewDiv.textContent = 'No matching numbers found';
                        countSpan.textContent = '0';
                    } else {
                        previewDiv.innerHTML = '';
                        // Show breakdown
                        const breakdownDiv = document.createElement('div');
                        breakdownDiv.className = 'mb-2 text-xs text-gray-500';
                        breakdownDiv.textContent = `Breakdown: ${groupBreakdown.join(', ')}`;
                        previewDiv.appendChild(breakdownDiv);
                        // Show numbers
                        matchingArray.forEach(num => {
                            const badge = document.createElement('span');
                            badge.className = 'inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-1 rounded mr-1 mb-1';
                            badge.textContent = num;
                            previewDiv.appendChild(badge);
                        });
                        countSpan.textContent = matchingArray.length;
                    }
                } else {
                    // Single mode - original behavior
                    if (digitsInput.length !== 2) {
                        previewDiv.textContent = 'Enter two digits to see matching numbers';
                        countSpan.textContent = '0';
                        return;
                    }

                    // Validate input
                    const d1 = parseInt(digitsInput[0]);
                    const d2 = parseInt(digitsInput[1]);

                    if (isNaN(d1) || isNaN(d2) || d1 < 0 || d1 > 9 || d2 < 0 || d2 > 9) {
                        previewDiv.textContent = 'Please enter valid digits (0-9)';
                        countSpan.textContent = '0';
                        return;
                    }

                    // Generate all 3-digit numbers containing both digits
                    const matchingNumbers = [];

                    // Iterate through all valid numbers and check if they contain both digits
                    validNumbers.forEach(numStr => {
                        const digits = numStr.split('');
                        const d1Str = String(d1);
                        const d2Str = String(d2);

                        // Check if the number contains both digit1 and digit2
                        if (digits.includes(d1Str) && digits.includes(d2Str)) {
                            matchingNumbers.push(numStr);
                        }
                    });

                    // Sort and display
                    matchingNumbers.sort();

                    if (matchingNumbers.length === 0) {
                        previewDiv.textContent = 'No matching numbers found';
                        countSpan.textContent = '0';
                    } else {
                        // Create badge elements for each number
                        previewDiv.innerHTML = '';
                        matchingNumbers.forEach(num => {
                            const badge = document.createElement('span');
                            badge.className = 'inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-1 rounded mr-1 mb-1';
                            badge.textContent = num;
                            previewDiv.appendChild(badge);
                        });
                        countSpan.textContent = matchingNumbers.length;
                    }
                }
            }

            document.getElementById('groupBetDigitsInput').addEventListener('input', function (e) {
                const isMultipleMode = document.getElementById('multipleGroupCheckbox').checked;
                if (isMultipleMode) {
                    // Allow digits and commas in multiple mode
                    let value = e.target.value.replace(/[^0-9,]/g, '');
                    e.target.value = value;
                } else {
                    // Only digits in single mode
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value.length > 2) value = value.slice(0, 2);
                    e.target.value = value;
                }
                updateGroupBetPreview();
            });

            // Add listeners for all checkbox types
            addCheckboxListeners('betColumnCheckbox', 'indigo');
            addCheckboxListeners('jodiColumnCheckbox', 'purple');
            addCheckboxListeners('abrCutColumnCheckbox', 'pink');
            addCheckboxListeners('jodiPanelColumnCheckbox', 'teal');
            addCheckboxListeners('columnBetCheckbox', 'emerald');
            // Quick Bet Entry functionality
            let quickBetRowCounter = 2;
            const validNumbers = new Set();
            // Build valid numbers set from ALL_COLUMN_DATA (already defined above)
            allColumnData.forEach(column => {
                column.forEach(num => {
                    let numStr = String(num);
                    // Pad numbers to 3 digits (e.g., 0 becomes '000', 1 becomes '001')
                    if (numStr.length < 3) {
                        numStr = numStr.padStart(3, '0');
                    }
                    validNumbers.add(numStr);
                });
            });
            document.addEventListener('input', function (e) {
                if (e.target.classList.contains('quick-bet-number')) {
                    const input = e.target;
                    const rowNum = input.dataset.row;
                    input.value = input.value.replace(/[^0-9]/g, '');
                    // Check if it's a valid 3-digit number
                    if (input.value.length === 3) {
                        if (!validNumbers.has(input.value)) {
                            input.classList.add('border-red-500', 'bg-red-50');
                            showToast('Invalid Number', `${input.value} is not in the allowed numbers list`, 'error');
                        } else {
                            input.classList.remove('border-red-500', 'bg-red-50');
                            input.classList.add('border-green-500', 'bg-green-50');
                        }
                    } else {
                        input.classList.remove('border-red-500', 'bg-red-50', 'border-green-500', 'bg-green-50');
                    }
                    // Auto-add new row when user starts typing in the last row
                    const allRows = document.querySelectorAll('#quickBetTableBody tr');
                    const lastRow = allRows[allRows.length - 1];
                    const lastRowNum = parseInt(lastRow.dataset.row);
                    if (parseInt(rowNum) === lastRowNum && input.value.length > 0) {
                        addQuickBetRow();
                    }
                }
            });
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    const target = e.target;
                    // Check if it's a quick bet input field
                    if (target.classList.contains('quick-bet-number') || target.classList.contains('quick-bet-amount')) {
                        e.preventDefault(); // Prevent form submission
                        const currentRow = parseInt(target.dataset.row);
                        const isNumberField = target.classList.contains('quick-bet-number');
                        // Check if "same amount" checkbox is checked
                        const sameAmountCheckbox = document.getElementById('sameAmountCheckbox');
                        if (isNumberField) {
                            // If checkbox is checked, skip to next row's number field
                            if (sameAmountCheckbox.checked) {
                                const nextRow = currentRow + 1;
                                let nextNumberInput = document.querySelector(`.quick-bet-number[data-row="${nextRow}"]`);
                                // If next row doesn't exist, create it
                                if (!nextNumberInput) {
                                    addQuickBetRow();
                                    nextNumberInput = document.querySelector(`.quick-bet-number[data-row="${nextRow}"]`);
                                }
                                if (nextNumberInput) {
                                    nextNumberInput.focus();
                                }
                            } else {
                                // Normal behavior: Jump from number field to amount field in same row
                                const amountInput = document.querySelector(`.quick-bet-amount[data-row="${currentRow}"]`);
                                if (amountInput) {
                                    amountInput.focus();
                                }
                            }
                        } else {
                            // Jump from amount field to number field in next row
                            const nextRow = currentRow + 1;
                            let nextNumberInput = document.querySelector(`.quick-bet-number[data-row="${nextRow}"]`);
                            // If next row doesn't exist, create it
                            if (!nextNumberInput) {
                                addQuickBetRow();
                                nextNumberInput = document.querySelector(`.quick-bet-number[data-row="${nextRow}"]`);
                            }
                            if (nextNumberInput) {
                                nextNumberInput.focus();
                            }
                        }
                    }
                }
            });
            // Same Amount Checkbox - auto-fill amounts from first row
            document.getElementById('sameAmountCheckbox').addEventListener('change', function () {
                if (this.checked) {
                    const firstAmountInput = document.querySelector('.quick-bet-amount[data-row="1"]');
                    const firstAmount = firstAmountInput.value;
                    if (firstAmount && parseFloat(firstAmount) > 0) {
                        // Fill all other amount fields with the same value
                        const allAmountInputs = document.querySelectorAll('.quick-bet-amount');
                        allAmountInputs.forEach(input => {
                            if (input.dataset.row !== '1') {
                                input.value = firstAmount;
                                input.readOnly = true;
                                input.classList.add('bg-gray-100');
                            }
                        });
                        showToast('Same Amount Applied', `All amounts set to ${firstAmount}`, 'success');
                    } else {
                        showToast('Enter Amount First', 'Please enter an amount in the first row', 'warning');
                        this.checked = false;
                    }
                } else {
                    // Re-enable all amount fields
                    const allAmountInputs = document.querySelectorAll('.quick-bet-amount');
                    allAmountInputs.forEach(input => {
                        if (input.dataset.row !== '1') {
                            input.readOnly = false;
                            input.classList.remove('bg-gray-100');
                        }
                    });
                }
            });
            // Watch first row amount input - update others when checkbox is checked
            document.addEventListener('input', function (e) {
                if (e.target.classList.contains('quick-bet-amount') && e.target.dataset.row === '1') {
                    const sameAmountCheckbox = document.getElementById('sameAmountCheckbox');
                    if (sameAmountCheckbox.checked) {
                        const firstAmount = e.target.value;
                        const allAmountInputs = document.querySelectorAll('.quick-bet-amount');
                        allAmountInputs.forEach(input => {
                            if (input.dataset.row !== '1') {
                                input.value = firstAmount;
                            }
                        });
                    }
                }
            });
            // Add new row to quick bet table
            function addQuickBetRow() {
                quickBetRowCounter++;
                const tbody = document.getElementById('quickBetTableBody');
                const newRow = document.createElement('tr');
                newRow.dataset.row = quickBetRowCounter;
                newRow.innerHTML = `
                        <td class="border border-gray-300 px-2 py-2 text-center text-sm font-medium text-gray-600">${quickBetRowCounter}</td>
                        <td class="border border-gray-300 p-1">
                            <input type="text" 
                                class="quick-bet-number w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                placeholder="3-digit" 
                                maxlength="3"
                                data-row="${quickBetRowCounter}">
                        </td>
                        <td class="border border-gray-300 p-1">
                            <input type="number" 
                                class="quick-bet-amount w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                placeholder="Amount"
                                min="1"
                                data-row="${quickBetRowCounter}">
                        </td>
                        <td class="border border-gray-300 p-1 text-center">
                            <button class="remove-row-btn text-red-500 hover:text-red-700 hover:bg-red-50 rounded p-1 transition" title="Remove row">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </td>
                    `;
                tbody.appendChild(newRow);
                // If "same amount" checkbox is checked, apply the first row's amount to new row
                const sameAmountCheckbox = document.getElementById('sameAmountCheckbox');
                if (sameAmountCheckbox.checked) {
                    const firstAmountInput = document.querySelector('.quick-bet-amount[data-row="1"]');
                    const firstAmount = firstAmountInput.value;
                    if (firstAmount) {
                        const newAmountInput = newRow.querySelector('.quick-bet-amount');
                        newAmountInput.value = firstAmount;
                        newAmountInput.readOnly = true;
                        newAmountInput.classList.add('bg-gray-100');
                    }
                }
            }
            // Remove row button event listener (event delegation)
            document.getElementById('quickBetTableBody').addEventListener('click', function (e) {
                const removeBtn = e.target.closest('.remove-row-btn');
                if (removeBtn) {
                    const row = removeBtn.closest('tr');
                    const tbody = document.getElementById('quickBetTableBody');
                    // Prevent removing if only one row left
                    if (tbody.querySelectorAll('tr').length <= 1) {
                        showToast('Cannot Remove', 'At least one row must remain', 'warning');
                        return;
                    }
                    row.remove();
                    // Re-number remaining rows
                    const remainingRows = tbody.querySelectorAll('tr');
                    remainingRows.forEach((row, index) => {
                        const rowNum = index + 1;
                        row.dataset.row = rowNum;
                        row.querySelector('td:first-child').textContent = rowNum;
                        row.querySelectorAll('input').forEach(input => {
                            input.dataset.row = rowNum;
                        });
                    });
                    quickBetRowCounter = remainingRows.length;
                    // If "same amount" checkbox is checked and we removed a row, re-apply the logic
                    const sameAmountCheckbox = document.getElementById('sameAmountCheckbox');
                    if (sameAmountCheckbox.checked) {
                        const firstAmountInput = document.querySelector('.quick-bet-amount[data-row="1"]');
                        const firstAmount = firstAmountInput.value;
                        if (firstAmount) {
                            const allAmountInputs = document.querySelectorAll('.quick-bet-amount');
                            allAmountInputs.forEach(input => {
                                if (input.dataset.row !== '1') {
                                    input.value = firstAmount;
                                    input.readOnly = true;
                                    input.classList.add('bg-gray-100');
                                }
                            });
                        }
                    }
                }
            });
            // Place bets button
            document.getElementById('quickBetOkayBtn').addEventListener('click', async function () {
                const numberInputs = document.querySelectorAll('.quick-bet-number');
                const amountInputs = document.querySelectorAll('.quick-bet-amount');
                const betsToPlace = [];
                console.log('Quick Bet: Starting validation for', numberInputs.length, 'rows');
                console.log('Valid numbers count:', validNumbers.size);
                for (let i = 0; i < numberInputs.length; i++) {
                    const number = numberInputs[i].value.trim();
                    const amount = amountInputs[i].value.trim();
                    if (number && amount) {
                        // Validate number
                        if (number.length !== 3) {
                            showToast('Invalid Entry', `Row ${i + 1}: Number must be 3 digits`, 'error');
                            return;
                        }
                        if (!validNumbers.has(number)) {
                            console.error(`Number ${number} not in validNumbers set`);
                            showToast('Invalid Number', `Row ${i + 1}: ${number} is not allowed`, 'error');
                            return;
                        }
                        // Validate amount
                        const amountNum = parseFloat(amount);
                        if (isNaN(amountNum) || amountNum <= 0) {
                            showToast('Invalid Amount', `Row ${i + 1}: Amount must be greater than 0`, 'error');
                            return;
                        }
                        betsToPlace.push({ number, amount: amountNum });
                    } else if (number || amount) {
                        // One field filled but not the other
                        showToast('Incomplete Entry', `Row ${i + 1}: Please fill both number and amount`, 'warning');
                        return;
                    }
                }
                if (betsToPlace.length === 0) {
                    showToast('No Bets', 'Please enter at least one bet', 'warning');
                    return;
                }
                console.log('Quick Bet: Placing', betsToPlace.length, 'bets');
                // Show loader before placing bets
                showLoader('Placing bets...');
                // Place all bets
                let successCount = 0;
                let failCount = 0;
                const failedBets = [];
                try {
                    for (const bet of betsToPlace) {
                        try {
                            const response = await fetch(API.PLACE_BET, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({
                                    number: bet.number,
                                    amount: bet.amount,
                                    bazar: currentBazar,
                                    date: currentDate
                                })
                            });
                            const result = await response.json();
                            if (result.success) {
                                successCount++;
                                const num = bet.number;
                                if (!bets[num]) bets[num] = { total: 0, history: [] };
                                bets[num].total += parseFloat(bet.amount);
                                bets[num].history.push({
                                    id: result.bet_id,
                                    amount: parseFloat(bet.amount),
                                    created_at: new Date().toISOString(),
                                    bet_type: 'SINGLE'
                                });
                                updateBetTotal(num);
                            } else {
                                failCount++;
                                failedBets.push(`${bet.number} (${bet.amount})`);
                                console.error('Bet failed:', result.error || 'Unknown error');
                            }
                        } catch (error) {
                            failCount++;
                            failedBets.push(`${bet.number} (${bet.amount})`);
                            console.error('Bet error:', error);
                        }
                    }
                } finally {
                    hideLoader();
                }
                if (successCount > 0 && failCount === 0) {
                    showToast('Success!', `${successCount} bet(s) placed successfully`, 'success');
                    document.getElementById('quickBetClearBtn').click();
                    // Reload bets and update total
                    await loadBets();
                    await updateTotalAmount();
                    await refreshAllBetTotals();
                    renderPage(1);
                } else if (successCount > 0 && failCount > 0) {
                    showToast('Partial Success', `${successCount} bet(s) placed, ${failCount} failed: ${failedBets.join(', ')}`, 'warning');
                    // Reload bets and update total
                    await loadBets();
                    await updateTotalAmount();
                    await refreshAllBetTotals();
                    renderPage(1);
                } else if (failCount > 0) {
                    showToast('Failed', `All ${failCount} bet(s) failed to place: ${failedBets.join(', ')}`, 'error');
                }
            });
            document.getElementById('quickBetClearBtn').addEventListener('click', function () {
                const tbody = document.getElementById('quickBetTableBody');
                tbody.innerHTML = `
                        <tr data-row="1">
                            <td class="border border-gray-300 px-2 py-2 text-center text-sm font-medium text-gray-600">1</td>
                            <td class="border border-gray-300 p-1">
                                <input type="text" 
                                    class="quick-bet-number w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                    placeholder="3-digit" 
                                    maxlength="3"
                                    data-row="1">
                            </td>
                            <td class="border border-gray-300 p-1">
                                <input type="number" 
                                    class="quick-bet-amount w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                    placeholder="Amount"
                                    min="1"
                                    data-row="1">
                            </td>
                            <td class="border border-gray-300 p-1 text-center">
                                <button class="remove-row-btn text-red-500 hover:text-red-700 hover:bg-red-50 rounded p-1 transition" title="Remove row">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        <tr data-row="2">
                            <td class="border border-gray-300 px-2 py-2 text-center text-sm font-medium text-gray-600">2</td>
                            <td class="border border-gray-300 p-1">
                                <input type="text" 
                                    class="quick-bet-number w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                    placeholder="3-digit" 
                                    maxlength="3"
                                    data-row="2">
                            </td>
                            <td class="border border-gray-300 p-1">
                                <input type="number" 
                                    class="quick-bet-amount w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                    placeholder="Amount"
                                    min="1"
                                    data-row="2">
                            </td>
                            <td class="border border-gray-300 p-1 text-center">
                                <button class="remove-row-btn text-red-500 hover:text-red-700 hover:bg-red-50 rounded p-1 transition" title="Remove row">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                quickBetRowCounter = 2;
                // Uncheck the "same amount" checkbox
                const sameAmountCheckbox = document.getElementById('sameAmountCheckbox');
                sameAmountCheckbox.checked = false;
            });
            // Toggle Quick Bet Container
            document.getElementById('toggleQuickBetBtn').addEventListener('click', function () {
                const container = document.getElementById('quickBetContainer');
                container.classList.toggle('hidden');
            });
            document.getElementById('closeQuickBetBtn').addEventListener('click', function () {
                document.getElementById('quickBetContainer').classList.add('hidden');
            });
            // History Modal Functions
            const historyModal = document.getElementById('historyModal');
            const historyTableBody = document.getElementById('historyTableBody');
            async function loadBulkActionHistory() {
                try {
                    // Build URL with bazar and date filters
                    let url = `${API.GET_BULK_HISTORY}?bazar=${currentBazar}&date=${currentDate}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.success) {
                        renderHistoryTable(data.history);
                        updateHistoryStats(data.history);
                    } else {
                        showToast('Error', 'Failed to load history', 'error');
                    }
                } catch (err) {
                    console.error('Error loading history:', err);
                    showToast('Error', 'Failed to load history', 'error');
                }
            }
            function renderHistoryTable(history) {
                historyTableBody.innerHTML = '';
                if (history.length === 0) {
                    historyTableBody.innerHTML = `
                            <tr>
                                <td colspan="11" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                    No history records found
                                </td>
                            </tr>
                        `;
                    return;
                }
                history.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white hover:bg-purple-50' : 'bg-gray-50 hover:bg-purple-50';
                    // Action type with color coding
                    let actionTypeClass = 'bg-gray-100 text-gray-800';
                    if (record.action_type === 'SP') actionTypeClass = 'bg-lime-100 text-lime-800';
                    else if (record.action_type === 'DP') actionTypeClass = 'bg-blue-100 text-blue-800';
                    else if (record.action_type === 'JODI') actionTypeClass = 'bg-purple-100 text-purple-800';
                    else if (record.action_type === 'EKI') actionTypeClass = 'bg-cyan-100 text-cyan-800';
                    else if (record.action_type === 'BEKI') actionTypeClass = 'bg-cyan-100 text-cyan-800';
                    else if (record.action_type === 'DADAR') actionTypeClass = 'bg-yellow-100 text-yellow-800';
                    else if (record.action_type === 'ABR_CUT') actionTypeClass = 'bg-pink-100 text-pink-800';
                    else if (record.action_type === 'JODI_PANEL') actionTypeClass = 'bg-teal-100 text-teal-800';
                    else if (record.action_type === 'MOTAR') actionTypeClass = 'bg-orange-100 text-orange-800';
                    else if (record.action_type === 'COMMAN_PANA_36') actionTypeClass = 'bg-blue-100 text-blue-800';
                    else if (record.action_type === 'COMMAN_PANA_56') actionTypeClass = 'bg-indigo-100 text-indigo-800';
                    else if (record.action_type === 'SET_PANA') actionTypeClass = 'bg-violet-100 text-violet-800';
                    else if (record.action_type === 'GROUP') actionTypeClass = 'bg-fuchsia-100 text-fuchsia-800';
                    // Status badge
                    const statusBadge = record.is_undone
                        ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded">Undone</span>'
                        : '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">Active</span>';
                    // Delete button - only show if not already undone
                    const deleteButton = record.is_undone
                        ? '<span class="text-gray-400 text-sm">-</span>'
                        : `<button onclick="deleteBulkAction(${record.id})" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-colors" title="Delete bulk action">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>`;
                    // Format bazar name
                    const bazarName = record.bazar ? bazarNames[record.bazar] || record.bazar : '-';
                    row.innerHTML = `
                            <td class="border border-gray-300 px-4 py-2 text-sm font-mono">${record.id}</td>
                            <td class="border border-gray-300 px-4 py-2">
                                <span class="px-2 py-1 ${actionTypeClass} text-xs font-semibold rounded">${record.action_type}</span>
                            </td>
                            <td class="border border-gray-300 px-4 py-2 text-sm text-gray-700">${bazarName}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm font-mono">${record.action_date || '-'}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm font-semibold text-green-700">${parseFloat(record.amount).toLocaleString('en-IN')}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm text-center font-semibold">${record.total_bets}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">${record.jodi_column || '-'}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">${record.jodi_type || '-'}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm font-mono">${record.created_at}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">${statusBadge}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">${deleteButton}</td>
                        `;
                    historyTableBody.appendChild(row);
                });
            }
            function updateHistoryStats(history) {
                const totalRecords = history.length;
                const totalAmount = history.reduce((sum, record) => sum + parseFloat(record.amount) * record.total_bets, 0);
                const totalBets = history.reduce((sum, record) => sum + record.total_bets, 0);
                document.getElementById('totalRecords').textContent = totalRecords;
                document.getElementById('totalHistoryAmount').textContent = `${totalAmount.toLocaleString('en-IN')}`;
                document.getElementById('totalHistoryBets').textContent = totalBets;
            }

            // Individual Bet History Functions
            const individualBetsTableBody = document.getElementById('individualBetsTableBody');

            async function loadIndividualBetHistory() {
                try {
                    // Load all bets for the current bazar and date (including bulk bets)
                    let url = `${API.LOAD_BETS}?bazar=${currentBazar}&date=${currentDate}`;
                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.success) {
                        // Include ALL bets (both individual and bulk) so users can delete any bet
                        const individualBets = [];
                        for (const [number, betData] of Object.entries(data.bets)) {
                            if (betData.history && Array.isArray(betData.history)) {
                                betData.history.forEach(bet => {
                                    // Include all bets - both individual and bulk
                                    individualBets.push({
                                        ...bet,
                                        number: number
                                    });
                                });
                            }
                        }

                        // Sort by created_at descending (newest first)
                        individualBets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                        renderIndividualBetsTable(individualBets);
                        updateIndividualBetsStats(individualBets);
                    } else {
                        showToast('Error', 'Failed to load individual bets', 'error');
                    }
                } catch (err) {
                    console.error('Error loading individual bets:', err);
                    showToast('Error', 'Failed to load individual bets', 'error');
                }
            }

            function renderIndividualBetsTable(bets) {
                individualBetsTableBody.innerHTML = '';

                if (bets.length === 0) {
                    individualBetsTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                No individual bets found
                            </td>
                        </tr>
                    `;
                    return;
                }

                bets.forEach((bet, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white hover:bg-blue-50' : 'bg-gray-50 hover:bg-blue-50';

                    // Bet type with color coding
                    let betTypeClass = 'bg-gray-100 text-gray-800';
                    if (bet.bet_type === 'SINGLE') betTypeClass = 'bg-green-100 text-green-800';
                    else if (bet.bet_type === 'SP') betTypeClass = 'bg-lime-100 text-lime-800';
                    else if (bet.bet_type === 'DP') betTypeClass = 'bg-blue-100 text-blue-800';
                    else if (bet.bet_type === 'JODI') betTypeClass = 'bg-purple-100 text-purple-800';
                    else if (bet.bet_type === 'GROUP') betTypeClass = 'bg-fuchsia-100 text-fuchsia-800';

                    // Format bazar name
                    const bazarName = bet.bazar ? bazarNames[bet.bazar] || bet.bazar : currentBazar;
                    const displayBazarName = bazarNames[bazarName] || bazarName;

                    // Format date
                    const betDate = bet.bet_date || currentDate;

                    // Format timestamp
                    const timestamp = new Date(bet.created_at).toLocaleString('en-IN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });

                    // Delete button
                    const deleteButton = `<button onclick="deleteIndividualBet(${bet.id}, '${bet.number}')" 
                        class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-colors" title="Delete bet">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>`;

                    row.innerHTML = `
                        <td class="border border-gray-300 px-4 py-2 text-sm font-mono">${bet.id}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm font-mono font-bold">${bet.number}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm font-semibold text-green-700">${parseFloat(bet.amount).toLocaleString('en-IN')}</td>
                        <td class="border border-gray-300 px-4 py-2">
                            <span class="px-2 py-1 ${betTypeClass} text-xs font-semibold rounded">${bet.bet_type}</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-sm text-gray-700">${displayBazarName}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm font-mono">${betDate}</td>
                        <td class="border border-gray-300 px-4 py-2 text-sm font-mono">${timestamp}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${deleteButton}</td>
                    `;

                    individualBetsTableBody.appendChild(row);
                });
            }

            function updateIndividualBetsStats(bets) {
                const totalRecords = bets.length;
                const totalAmount = bets.reduce((sum, bet) => sum + parseFloat(bet.amount), 0);
                const totalBets = bets.length;

                document.getElementById('totalRecords').textContent = totalRecords;
                document.getElementById('totalHistoryAmount').textContent = `${totalAmount.toLocaleString('en-IN')}`;
                document.getElementById('totalHistoryBets').textContent = totalBets;
            }

            // Delete individual bet function
            window.deleteIndividualBet = async function (betId, number) {
                if (!confirm('Are you sure you want to delete this bet?')) {
                    return;
                }

                try {
                    const response = await fetch(API.DELETE_BET, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ bet_id: betId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast('Deleted!', 'Bet deleted successfully', 'success');

                        // Reload individual bets table
                        await loadIndividualBetHistory();

                        // Reload main bets and update totals
                        await loadBets();
                        await updateTotalAmount();
                        renderPage(1);
                    } else {
                        showToast('Error', data.message || 'Failed to delete bet', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting bet:', error);
                    showToast('Error', 'Failed to delete bet', 'error');
                }
            };

            // Tab Switching Functions
            const bulkActionsTab = document.getElementById('bulkActionsTab');
            const individualBetsTab = document.getElementById('individualBetsTab');
            const bulkActionsContent = document.getElementById('bulkActionsContent');
            const individualBetsContent = document.getElementById('individualBetsContent');

            function switchToBulkActionsTab() {
                bulkActionsContent.classList.remove('hidden');
                individualBetsContent.classList.add('hidden');
                bulkActionsTab.classList.add('border-indigo-600', 'text-indigo-600');
                bulkActionsTab.classList.remove('border-transparent', 'text-gray-500');
                individualBetsTab.classList.remove('border-indigo-600', 'text-indigo-600');
                individualBetsTab.classList.add('border-transparent', 'text-gray-500');
                loadBulkActionHistory();
            }

            function switchToIndividualBetsTab() {
                bulkActionsContent.classList.add('hidden');
                individualBetsContent.classList.remove('hidden');
                individualBetsTab.classList.add('border-indigo-600', 'text-indigo-600');
                individualBetsTab.classList.remove('border-transparent', 'text-gray-500');
                bulkActionsTab.classList.remove('border-indigo-600', 'text-indigo-600');
                bulkActionsTab.classList.add('border-transparent', 'text-gray-500');
                loadIndividualBetHistory();
            }

            bulkActionsTab.addEventListener('click', switchToBulkActionsTab);
            individualBetsTab.addEventListener('click', switchToIndividualBetsTab);

            // Delete bulk action function
            window.deleteBulkAction = async function (bulkActionId) {
                if (!confirm('Are you sure you want to delete this bulk action? All associated bets will be permanently deleted.')) {
                    return;
                }
                try {
                    const response = await fetch(API.UNDO_BULK, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ bulk_action_id: bulkActionId })
                    });
                    // Check if response is ok
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.success) {
                        showToast('Deleted!', data.message, 'success');
                        // Reload history table
                        await loadBulkActionHistory();
                        // Reload bets and update totals
                        await loadBets();
                        await updateTotalAmount();
                        renderPage(1);
                        await getLastBulkAction();
                    } else {
                        showToast('Error', data.message || 'Failed to delete bulk action', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting bulk action:', error);
                    showToast('Error', error.message || 'Failed to delete bulk action', 'error');
                }
            };
            // Toggle History Modal
            document.getElementById('toggleHistoryBtn').addEventListener('click', function () {
                historyModal.classList.remove('hidden');
                loadBulkActionHistory();
            });
            document.getElementById('closeHistoryModal').addEventListener('click', function () {
                historyModal.classList.add('hidden');
            });
            document.getElementById('refreshHistoryBtn').addEventListener('click', function () {
                loadBulkActionHistory();
                showToast('Refreshed', 'History data updated', 'success');
            });
            // Sidebar functions
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const openSidebarBtn = document.getElementById('openSidebar');
            const closeSidebarBtn = document.getElementById('closeSidebar');
            const bazarSelectorSidebar = document.getElementById('bazarSelectorSidebar');
            const dateSelectorSidebar = document.getElementById('dateSelectorSidebar');
            function openSidebar() {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                openSidebarBtn.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            function closeSidebar() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                openSidebarBtn.classList.remove('active');
                document.body.style.overflow = '';
            }
            openSidebarBtn.addEventListener('click', openSidebar);
            closeSidebarBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
            // Toggle button for showing all bet types
            const showAllBetTypesToggle = document.getElementById('showAllBetTypesToggle');
            const betButtonsContainer = document.getElementById('betButtonsContainer');
            // Function to update button visibility based on toggle state
            function updateBetButtonsVisibility() {
                if (showAllBetTypesToggle && betButtonsContainer) {
                    if (showAllBetTypesToggle.checked) {
                        // Toggle ON - Show buttons
                        betButtonsContainer.classList.remove('hidden');
                    } else {
                        // Toggle OFF - Hide buttons
                        betButtonsContainer.classList.add('hidden');
                    }
                }
            }
            // Initial visibility check on page load
            updateBetButtonsVisibility();
            if (showAllBetTypesToggle) {
                showAllBetTypesToggle.addEventListener('change', function () {
                    updateBetButtonsVisibility();
                    showToast('Button Visibility', showAllBetTypesToggle.checked ? 'All bet type buttons visible' : 'Bet type buttons hidden', 'info');
                });
            }
            // Load database storage info
            async function loadDatabaseStorage() {
                try {
                    const res = await fetch(API.GET_DATABASE_STORAGE);
                    const data = await res.json();
                    if (data.success) {
                        const storageUsed = document.getElementById('storageUsed');
                        const storagePercentage = document.getElementById('storagePercentage');
                        const storageProgressBar = document.getElementById('storageProgressBar');
                        const databaseType = document.getElementById('databaseType');
                        storageUsed.textContent = `${data.storage_used_mb} MB / ${data.storage_total_mb} MB`;
                        storagePercentage.textContent = `${data.percentage}%`;
                        storageProgressBar.style.width = `${Math.min(data.percentage, 100)}%`;
                        databaseType.textContent = data.database_type;
                        // Change color based on usage
                        if (data.percentage >= 90) {
                            storageProgressBar.style.background = 'linear-gradient(to right, #ef4444, #dc2626)'; // Red
                        } else if (data.percentage >= 70) {
                            storageProgressBar.style.background = 'linear-gradient(to right, #f59e0b, #d97706)'; // Orange
                        } else {
                            storageProgressBar.style.background = 'linear-gradient(to right, #3b82f6, #06b6d4)'; // Blue
                        }
                    } else {
                        console.error('Failed to load storage info:', data.error);
                        document.getElementById('storageUsed').textContent = 'Error loading';
                    }
                } catch (err) {
                    console.error('Error loading database storage:', err);
                    document.getElementById('storageUsed').textContent = 'N/A';
                }
            }
            // Date population is now handled by Django template (see date_options in views.py)
            // No need for JavaScript date generation
            function updateBazarDateDisplay() {
                const bazarDisplay = document.getElementById('currentBazarDisplay');
                const dateDisplay = document.getElementById('currentDateDisplay');
                const bazarDisplaySidebar = document.getElementById('currentBazarDisplaySidebar');
                const dateDisplaySidebar = document.getElementById('currentDateDisplaySidebar');
                const displayText = bazarNames[currentBazar];
                const dateText = dateSelectorSidebar.options[dateSelectorSidebar.selectedIndex].text;
                bazarDisplay.textContent = displayText;
                dateDisplay.textContent = dateText;
                bazarDisplaySidebar.textContent = displayText;
                dateDisplaySidebar.textContent = dateText;
                // Sync selectors
                bazarSelectorSidebar.value = currentBazar;
                dateSelectorSidebar.value = currentDate;
            }
            bazarSelectorSidebar.addEventListener('change', async function (e) {
                const newBazar = e.target.value;
                // Prevent duplicate execution
                if (newBazar === currentBazar) {
                    return;
                }
                try {
                    showLoader('Switching bazar...');
                    console.log('Switching from', currentBazar, 'to', newBazar);
                    currentBazar = newBazar;
                    // Save to localStorage to persist across page refreshes
                    localStorage.setItem('selectedBazar', newBazar);
                    updateBazarDateDisplay();
                    // Close sidebar
                    closeSidebar();
                    bets = {};
                    // Clear element cache on bazar change
                    betTotalElementCache.clear();
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">Loading...</td></tr>';
                    currentPage = 1;
                    // Reload all data for new bazar in parallel
                    updateLoader('Loading bets...');
                    const [betsResult, bulkResult, totalResult, syncResult, columnResult] = await Promise.allSettled([
                        loadBets(),
                        getLastBulkAction(),
                        updateTotalAmount(),
                        refreshAllBetTotals(),
                        refreshColumnTotals()
                    ]);
                    updateLoader('Processing data...');
                    // Check for errors
                    const errors = [betsResult, bulkResult, totalResult, syncResult, columnResult].filter(r => r.status === 'rejected');
                    if (errors.length > 0) {
                        console.error('Errors during bazar switch:', errors);
                    }
                    updateLoader('Complete!');
                    hideLoader();
                    showToast('Bazar Changed', `Switched to ${bazarNames[currentBazar]}`, 'success');
                    console.log('Bazar switch complete');
                } catch (error) {
                    console.error('Error switching bazar:', error);
                    hideLoader();
                    showToast('Error', 'Failed to switch bazar. Please try again.', 'error');
                    // Revert to previous bazar on error
                    e.target.value = currentBazar;
                    updateBazarDateDisplay();
                }
            });
            // Date change handler (sidebar)
            dateSelectorSidebar.addEventListener('change', async function (e) {
                const newDate = e.target.value;
                // Prevent duplicate execution
                if (newDate === currentDate) {
                    return;
                }
                try {
                    showLoader('Loading data...');
                    console.log('Changing from', currentDate, 'to', newDate);
                    currentDate = newDate;
                    updateBazarDateDisplay();
                    // Close sidebar
                    closeSidebar();
                    bets = {};
                    // Clear element cache on date change
                    betTotalElementCache.clear();
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">Loading...</td></tr>';
                    currentPage = 1;
                    // Reload all data for new date in parallel
                    updateLoader('Loading bets...');
                    const [betsResult, bulkResult, totalResult, syncResult] = await Promise.allSettled([
                        loadBets(),
                        getLastBulkAction(),
                        updateTotalAmount(),
                        refreshAllBetTotals()
                    ]);
                    updateLoader('Processing data...');
                    // Check for errors
                    const errors = [betsResult, bulkResult, totalResult, syncResult].filter(r => r.status === 'rejected');
                    if (errors.length > 0) {
                        console.error('Errors during date change:', errors);
                    }
                    updateLoader('Complete!');
                    hideLoader();
                    const selectedText = e.target.options[e.target.selectedIndex].text;
                    showToast('Date Changed', `Showing data for ${selectedText}`, 'success');
                    console.log('Date change complete');
                } catch (error) {
                    console.error('Error changing date:', error);
                    hideLoader();
                    showToast('Error', 'Failed to load data. Please try again.', 'error');
                    // Revert to previous date on error
                    e.target.value = currentDate;
                    updateBazarDateDisplay();
                }
            });
            // Close modal on outside click
            historyModal.addEventListener('click', function (e) {
                if (e.target === historyModal) {
                    historyModal.classList.add('hidden');
                }
            });
            // Initialize dates
            // Initial setup - dates are pre-populated by Django
            updateBazarDateDisplay();
            // Restore bazar selector to saved value
            if (bazarSelectorSidebar) bazarSelectorSidebar.value = currentBazar;
            const refreshBalanceBtn = document.getElementById('refreshBalanceBtn');
            const refreshBalanceBtnMobile = document.getElementById('refreshBalanceBtnMobile');
            if (refreshBalanceBtn) {
                refreshBalanceBtn.addEventListener('click', async () => {
                    refreshBalanceBtn.classList.add('animate-spin');
                    await updateTotalAmount();
                    setTimeout(() => refreshBalanceBtn.classList.remove('animate-spin'), 500);
                    showToast('Balance Updated', 'Total balance has been refreshed', 'success');
                });
            }
            if (refreshBalanceBtnMobile) {
                refreshBalanceBtnMobile.addEventListener('click', async () => {
                    refreshBalanceBtnMobile.classList.add('animate-spin');
                    await updateTotalAmount();
                    setTimeout(() => refreshBalanceBtnMobile.classList.remove('animate-spin'), 500);
                    showToast('Balance Updated', 'Total balance has been refreshed', 'success');
                });
            }
            // Load database storage info (defer to idle time)
            runWhenIdle(() => loadDatabaseStorage());
            renderPage(1);
            refreshColumnTotals();

            // Set up periodic polling for multi-device synchronization
            // Use longer interval and throttle to reduce server load
            let syncInterval = null;
            let isPageVisible = true;

            // Only sync when page is visible
            document.addEventListener('visibilitychange', () => {
                isPageVisible = !document.hidden;
                if (isPageVisible && !syncInterval) {
                    startSync();
                } else if (!isPageVisible && syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
            });

            function startSync() {
                syncInterval = setInterval(async () => {
                    if (isPageVisible) {
                        try {
                            await refreshAllBetTotals();
                        } catch (err) {
                            console.error('Sync error:', err);
                        }
                    }
                }, 15000); // 15 seconds (increased from 10)
            }

            startSync();

            window.addEventListener('beforeunload', () => {
                if (syncInterval) clearInterval(syncInterval);
            });

            // Initialize - load critical data first, defer non-critical
            showLoader('Initializing...');
            try {
                updateLoader('Loading bets...');
                // Load critical data in parallel
                const [betsResult, totalsResult] = await Promise.allSettled([
                    loadBets(),
                    refreshAllBetTotals()
                ]);
                
                updateLoader('Loading settings...');
                // Load secondary data
                await Promise.allSettled([
                    getLastBulkAction(),
                    updateTotalAmount()
                ]);
                
                updateLoader('Ready!');
            } catch (err) {
                console.error('Initialization error:', err);
            } finally {
                setTimeout(() => hideLoader(), 300);
            }

            // Master Delete Functions
            window.showMasterDeleteConfirmation = async function () {
                const modal = document.getElementById('masterDeleteModal');
                const checkbox = document.getElementById('confirmDeleteCheckbox');
                const passwordInput = document.getElementById('deletePassword');
                const confirmBtn = document.getElementById('confirmMasterDeleteBtn');
                const totalBetsCount = document.getElementById('totalBetsCount');

                if (!modal || !checkbox || !passwordInput || !confirmBtn || !totalBetsCount) {
                    showToast('Error', 'Modal elements not found. Please refresh the page.', 'error');
                    return;
                }

                // Show loading in count while fetching
                totalBetsCount.textContent = '...';

                // Fetch actual count from database
                try {
                    const response = await fetch("{% url 'userbaseapp:get_total_bet_count' %}", {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': getCSRFToken()
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            totalBetsCount.textContent = data.total_count;
                        } else {
                            totalBetsCount.textContent = '0';
                            showToast('Error', 'Failed to fetch bet count', 'error');
                        }
                    } else {
                        totalBetsCount.textContent = '0';
                        showToast('Error', 'Failed to fetch bet count', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching bet count:', error);
                    totalBetsCount.textContent = '0';
                    showToast('Error', 'Failed to fetch bet count', 'error');
                }

                // Reset form
                checkbox.checked = false;
                passwordInput.value = '';
                passwordInput.disabled = true;
                confirmBtn.disabled = true;

                // Show modal
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                // Setup checkbox listener
                checkbox.onchange = function () {
                    passwordInput.disabled = !this.checked;
                    if (this.checked) {
                        passwordInput.focus();
                    } else {
                        passwordInput.value = '';
                    }
                    updateDeleteButtonState();
                };

                // Setup password input listener
                passwordInput.oninput = updateDeleteButtonState;
            }

            window.updateDeleteButtonState = function () {
                const checkbox = document.getElementById('confirmDeleteCheckbox');
                const passwordInput = document.getElementById('deletePassword');
                const confirmBtn = document.getElementById('confirmMasterDeleteBtn');

                confirmBtn.disabled = !(checkbox.checked && passwordInput.value.length > 0);
            }

            window.cancelMasterDelete = function () {
                const modal = document.getElementById('masterDeleteModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            // Delete Bazar Database Functions
            window.showDeleteBazarConfirmation = async function () {
                const modal = document.getElementById('deleteBazarModal');
                const checkbox = document.getElementById('confirmBazarDeleteCheckbox');
                const confirmBtn = document.getElementById('confirmBazarDeleteBtn');

                // Reset modal state
                checkbox.checked = false;
                confirmBtn.disabled = true;

                // Update bazar name and date display
                document.getElementById('deleteBazarName').textContent = bazarNames[currentBazar] || currentBazar;
                document.getElementById('deleteBazarDate').textContent = currentDate;

                // Fetch bet count for current bazar and date
                try {
                    const response = await fetch(`${API.LOAD_BETS}?bazar=${currentBazar}&date=${currentDate}`);
                    const data = await response.json();
                    if (data.success) {
                        let totalBets = 0;
                        for (const [number, betData] of Object.entries(data.bets)) {
                            if (betData.history && Array.isArray(betData.history)) {
                                totalBets += betData.history.length;
                            }
                        }
                        document.getElementById('bazarBetsCount').textContent = totalBets;
                    }
                } catch (err) {
                    console.error('Error fetching bet count:', err);
                    document.getElementById('bazarBetsCount').textContent = '?';
                }

                // Setup checkbox listener
                checkbox.onchange = function () {
                    confirmBtn.disabled = !this.checked;
                };

                // Show modal
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            window.cancelBazarDelete = function () {
                const modal = document.getElementById('deleteBazarModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            window.executeBazarDelete = async function () {
                const confirmBtn = document.getElementById('confirmBazarDeleteBtn');

                // Disable button and show loading
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Deleting...';
                showLoader(`Deleting bets for ${bazarNames[currentBazar]}...`);

                try {
                    const response = await fetch(API.DELETE_BAZAR_BETS, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            bazar: currentBazar,
                            date: currentDate
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Reset UI
                        renderBets();
                        await updateTotalAmount();
                        await refreshAllBetTotals();

                        // Close modal
                        cancelBazarDelete();

                        // Show success message
                        showToast('Success', `Deleted ${data.deleted_count} bets for ${bazarNames[currentBazar]}`, 'success');
                    } else {
                        showToast('Error', data.error || 'Failed to delete bazar bets', 'error');
                    }
                } catch (err) {
                    console.error('Error deleting bazar bets:', err);
                    showToast('Error', 'Failed to delete bazar bets. Please try again.', 'error');
                } finally {
                    hideLoader();
                    confirmBtn.textContent = 'Delete Bazar Data';
                    confirmBtn.disabled = false;
                }
            }

            window.executeMasterDelete = async function () {
                console.log('Execute master delete called');
                const passwordInput = document.getElementById('deletePassword');
                const password = passwordInput.value;
                const confirmBtn = document.getElementById('confirmMasterDeleteBtn');

                console.log('Password length:', password.length);

                if (!password) {
                    showToast('Error', 'Please enter your password', 'error');
                    return;
                }

                // Disable button and show loading
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Deleting...';
                showLoader('Deleting all bets...');

                console.log('Sending delete request...');

                try {
                    const response = await fetch("{% url 'userbaseapp:master_delete_all_bets' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            password: password
                        })
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (data.success) {
                        // Clear local bets object
                        if (typeof window.bets !== 'undefined') {
                            for (const bazar in window.bets) {
                                delete window.bets[bazar];
                            }
                        }

                        // Reset UI
                        renderBets();
                        await updateTotalAmount();
                        await refreshAllBetTotals();

                        // Close modal
                        cancelMasterDelete();

                        // Show success message
                        showToast('Success', `${data.deleted_count} bets deleted successfully`, 'success');
                    } else {
                        showToast('Error', data.error || 'Failed to delete bets', 'error');
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Delete All Bets';
                    }
                } catch (error) {
                    console.error('Master delete error:', error);
                    showToast('Error', 'Network error. Please try again.', 'error');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Delete All Bets';
                } finally {
                    hideLoader();
                }
            }
        }); // End of DOMContentLoaded
    </script>
</body>

</html>